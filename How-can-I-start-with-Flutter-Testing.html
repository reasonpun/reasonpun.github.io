<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"pangz.fun","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4592202470693653" crossorigin="anonymous"></script><meta name="description" content="大家好! 👋这些天我开始了我的Flutter测试之旅。这个世界对我来说是未知的，但我知道在我们的应用程序中进行测试是超级重要的，我决定自己学习。也许我现在给你看的代码可以做得更好，但请记住，这是我第一次做flutter测试，我想向你展示我所做的，当然，如果你有任何建议，代码将是开源的。我对这个资源库的想法是为每个对学习测试感兴趣的人提供一个地方，创建新的内容，PR，并一起合作。"><meta property="og:type" content="article"><meta property="og:title" content="我怎样才能开始进行Flutter测试？"><meta property="og:url" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing.html"><meta property="og:site_name" content="酷学小栈"><meta property="og:description" content="大家好! 👋这些天我开始了我的Flutter测试之旅。这个世界对我来说是未知的，但我知道在我们的应用程序中进行测试是超级重要的，我决定自己学习。也许我现在给你看的代码可以做得更好，但请记住，这是我第一次做flutter测试，我想向你展示我所做的，当然，如果你有任何建议，代码将是开源的。我对这个资源库的想法是为每个对学习测试感兴趣的人提供一个地方，创建新的内容，PR，并一起合作。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/1.jpeg"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/2.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/3.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/4.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/5.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/6.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/7.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/8.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/9.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/10.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/11.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/12.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/13.png"><meta property="og:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/14.png"><meta property="article:published_time" content="2022-03-27T08:03:26.000Z"><meta property="article:modified_time" content="2025-01-23T09:09:21.641Z"><meta property="article:author" content="木辛念做梓"><meta property="article:tag" content="Flutter"><meta property="article:tag" content="CI&#x2F;CD"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pangz.fun/How-can-I-start-with-Flutter-Testing/1.jpeg"><link rel="canonical" href="https://pangz.fun/How-can-I-start-with-Flutter-Testing.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://pangz.fun/How-can-I-start-with-Flutter-Testing.html","path":"How-can-I-start-with-Flutter-Testing.html","title":"我怎样才能开始进行Flutter测试？"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>我怎样才能开始进行Flutter测试？ | 酷学小栈</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-1HVT1YE421"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-1HVT1YE421","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="酷学小栈" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">酷学小栈</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">还要再走500里</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%8F%E6%9C%BA%E7%8C%AB%E5%92%AA%F0%9F%90%B1"><span class="nav-number">1.</span> <span class="nav-text">随机猫咪🐱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E6%88%90%E5%8A%9F%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">2.</span> <span class="nav-text">请求成功的情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%81%E7%A7%8D%E5%88%97%E8%A1%A8%E4%B8%BA%E7%A9%BA%E6%88%96%E7%A9%BA%E7%9A%84%E6%88%90%E5%8A%9F%E6%A1%88%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">品种列表为空或空的成功案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%93response-body%E4%B8%BA%E7%A9%BA%E6%97%B6%E6%8A%9B%E5%87%BA%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF"><span class="nav-number">4.</span> <span class="nav-text">当response.body为空时抛出一个错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%93response-statusCode%E4%B8%8D%E6%98%AF200%E6%97%B6%EF%BC%8C%E6%8A%9B%E5%87%BA%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E3%80%82"><span class="nav-number">5.</span> <span class="nav-text">当response.statusCode不是200时，抛出一个错误。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A9%E6%88%91%E4%BB%AC%E8%BF%9B%E5%85%A5%E6%B5%8B%E8%AF%95-%F0%9F%A7%AA"><span class="nav-number">6.</span> <span class="nav-text">让我们进入测试 🧪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">7.</span> <span class="nav-text">单元测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bloc-Test"><span class="nav-number">8.</span> <span class="nav-text">Bloc Test</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#random-cat-bloc-test-dart"><span class="nav-number">8.1.</span> <span class="nav-text">random_cat_bloc_test.dart</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Widget%E6%B5%8B%E8%AF%95"><span class="nav-number">9.</span> <span class="nav-text">Widget测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">10.</span> <span class="nav-text">结论</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">木辛念做梓</p><div class="site-description" itemprop="description">读万卷书，行万里路，胸中脱去尘浊</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">110</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">114</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://io-oi.me/" title="https:&#x2F;&#x2F;io-oi.me" rel="noopener" target="_blank">reuixiy</a></li></ul></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://pangz.fun/How-can-I-start-with-Flutter-Testing.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="木辛念做梓"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="酷学小栈"><meta itemprop="description" content="读万卷书，行万里路，胸中脱去尘浊"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="我怎样才能开始进行Flutter测试？ | 酷学小栈"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">我怎样才能开始进行Flutter测试？</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-27 16:03:26" itemprop="dateCreated datePublished" datetime="2022-03-27T16:03:26+08:00">2022-03-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-01-23 17:09:21" itemprop="dateModified" datetime="2025-01-23T17:09:21+08:00">2025-01-23</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Flutter/" itemprop="url" rel="index"><span itemprop="name">Flutter</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>31k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>28 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><img src="/How-can-I-start-with-Flutter-Testing/1.jpeg" title="示意图 width=400"><p>大家好! 👋<br>这些天我开始了我的Flutter测试之旅。这个世界对我来说是未知的，但我知道在我们的应用程序中进行测试是超级重要的，我决定自己学习。<br>也许我现在给你看的代码可以做得更好，但请记住，这是我第一次做flutter测试，我想向你展示我所做的，当然，如果你有任何建议，代码将是开源的。<br>我对这个资源库的想法是为每个对学习测试感兴趣的人提供一个地方，创建新的内容，PR，并一起合作。</p><span id="more"></span><p>所以让我们开始吧! 🙌<br>首先，我想解释一下我创建的是一个什么样的项目。我创建了一个显示猫的应用程序，它来自一个获取猫猫的API。<br>在这种情况下，我创建了一个底部导航小部件，有三个页面。在这篇文章中，我们将重点讨论第一页。</p><h3 id="随机猫咪🐱"><a href="#随机猫咪🐱" class="headerlink" title="随机猫咪🐱"></a>随机猫咪🐱</h3><p>这个页面是一个随机猫咪的可视化工具，你只需要简单的点击就可以拥有看到世界上每个地方的猫咪的能力，很棒吧？<br>玩笑归玩笑，这个页面的想法是让用户在点击浮动的行动按钮时可以看到随机的猫咪。<br>为了得到这个结果，我把应用程序的结构保持得很简单，这篇文章不是关于架构的，所以我决定不花很多时间来做这个，而是努力专注于这个项目的目的：测试。🧪</p><img src="/How-can-I-start-with-Flutter-Testing/2.png" title="示意图 width=400"><p>总之，以下这就是应用程序文件夹的结构。</p><img src="/How-can-I-start-with-Flutter-Testing/3.png" title="示意图 width=400"><h3 id="请求成功的情况"><a href="#请求成功的情况" class="headerlink" title="请求成功的情况"></a>请求成功的情况</h3><p>在这个流程中，用户需要点击浮动按钮，这会触发了一个Bloc事件。<br>Bloc负责与存储库通信以获得下一只猫。<br>存储库调用一个API，获得下一只随机猫。<br>在这种情况下，流程是成功的，所以服务将返回一个猫对象给存储库，它将返回给Bloc。Bloc将检查该猫是否正确（如果它有一个非空的品种列表），在这种情况下会发出</p><pre class="line-numbers language-none"><code class="language-none">RandomCatStatus.success<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>视图有一个BlocConsumer，它有一个构建器，正在监听可能的状态变化，以重建视图。</p><img src="/How-can-I-start-with-Flutter-Testing/4.png" title="示意图 width=400"><h3 id="品种列表为空或空的成功案例"><a href="#品种列表为空或空的成功案例" class="headerlink" title="品种列表为空或空的成功案例"></a>品种列表为空或空的成功案例</h3><p>在这种情况下，服务返回一个正确的答案，但是猫的品种列表为空或空。<br>这个列表对于显示猫的信息是必要的。因此，当存储库将对象返回给bloc时，它将负责验证这个列表是否为空或空，在这个例子中，这个列表是空的，所以bloc将发出RandomCatStatus.emptyBreed。视图将在BlocConsumer的监听器上监听这个状态，当它发生时，视图应该再次调用该事件以获得另一只随机猫。</p><img src="/How-can-I-start-with-Flutter-Testing/5.png" title="示意图 width=400"><h3 id="当response-body为空时抛出一个错误"><a href="#当response-body为空时抛出一个错误" class="headerlink" title="当response.body为空时抛出一个错误"></a>当response.body为空时抛出一个错误</h3><p>这是另一种可能发生的情况，当服务响应的状态代码为200，但响应体是空的，在这种情况下，服务将抛出一个错误。<br>当一个错误被抛出时，Bloc上的try/catch将捕获这个错误并发出RandomCatStatus.failure。视图将监听这个状态，以显示一个带有错误的消息。</p><img src="/How-can-I-start-with-Flutter-Testing/6.png" title="示意图 width=400"><h3 id="当response-statusCode不是200时，抛出一个错误。"><a href="#当response-statusCode不是200时，抛出一个错误。" class="headerlink" title="当response.statusCode不是200时，抛出一个错误。"></a>当response.statusCode不是200时，抛出一个错误。</h3><p>例如，如果响应状态代码返回404或400，应用程序将抛出一个错误。Bloc会捕捉到这个错误，并向视图发出一个RandomCatStatus.failure。</p><img src="/How-can-I-start-with-Flutter-Testing/7.png" title="示意图 width=400"><p>这些是该应用程序的所有可能情况。</p><h3 id="让我们进入测试-🧪"><a href="#让我们进入测试-🧪" class="headerlink" title="让我们进入测试 🧪"></a>让我们进入测试 🧪</h3><p>现在是在flutter中进行测试的时候了。我们需要的第一件事是在pubspec.yaml中建立正确的依赖关系来进行测试。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
  <span class="token key atrule">mocktail</span><span class="token punctuation">:</span> ^0.3.0 // to mock classes
  <span class="token key atrule">network_image_mock</span><span class="token punctuation">:</span> ^2.0.1 // to mock image network
<span class="token key atrule">dev_dependencies</span><span class="token punctuation">:</span>
  <span class="token key atrule">flutter_test</span><span class="token punctuation">:</span>
    <span class="token key atrule">sdk</span><span class="token punctuation">:</span> flutter
  <span class="token key atrule">bloc_test</span><span class="token punctuation">:</span> ^9.0.3 // to do bloc testing<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很好，现在我们可以开始了! ✅</p><p>在根项目→测试文件夹中，我已经创建了这个。</p><img src="/How-can-I-start-with-Flutter-Testing/8.png" title="示意图 width=400"><p>在flutter中，我们可以做不同类型的测试。</p><ul><li>单元测试</li><li>块状测试</li><li>小工具测试</li><li>集成测试<br>在这里，我们将专注于前三种。<br>当你在测试时，你有不同的方法可以在做测试之后或之前使用。</li></ul><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token comment">// Registers a function to be run once before all tests</span>
<span class="token function">setUpAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Registers a function to be run before tests</span>
<span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Registers a function to be run after tests</span>
<span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Registers a function to be run once after all tests</span>
<span class="token function">tearDownAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>在这一部分，我将测试我在服务和资源库类上创建的方法。<br>这是 <strong>service.dart类</strong></p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:convert'</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/model/cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/model/result_error.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:http/http.dart'</span></span> <span class="token operator">as</span> http<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:http/http.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CatService</span> <span class="token punctuation">{</span>
  <span class="token class-name">CatService</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token class-name"><span class="token namespace">http<span class="token punctuation">.</span></span>Client</span><span class="token operator">?</span> httpClient<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'https://api.thecatapi.com/v1'</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _httpClient <span class="token operator">=</span> httpClient <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name"><span class="token namespace">http<span class="token punctuation">.</span></span>Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> <span class="token class-name">String</span> baseUrl<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Client</span> _httpClient<span class="token punctuation">;</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cat</span><span class="token punctuation">&gt;</span></span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token keyword">await</span> _httpClient
        <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">baseUrl</span></span><span class="token string">/images/search?has_breeds=true'</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Cat</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token class-name">ErrorEmptyResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ErrorSearchingCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这种情况下，我必须测试该服务可能出现的所有情况。要做到这一点，我需要做的第一件事就是为响应、对象等创建模拟类。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">MockHttp</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">http<span class="token punctuation">.</span></span>Client</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 
<span class="token keyword">class</span> <span class="token class-name">MockResponse</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">http<span class="token punctuation">.</span></span>Response</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FakeUri</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">Uri</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在main方法中，我创建了一个组，拥有所有与服务类相关的测试。在<strong>setUpAll</strong>方法中，我注册了一个**registerFallbackValue(FakeUri())**，因为我需要它在测试中使用一个假的URI。<br>如果我不这样做，我就不能使用any()方法。<br>另外，我已经为模拟创建了所需的变量。这些都将被实例化到setUp方法中。此外，我还在一个单独的类中创建了一个JSON变量来伪造API的结果（当API返回一个正确的猫时）。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Service'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  late <span class="token class-name">CatService</span> catService<span class="token punctuation">;</span>
  late <span class="token class-name">MockHttp</span> httpClient<span class="token punctuation">;</span>

  <span class="token function">setUpAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">FakeUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    httpClient <span class="token operator">=</span> <span class="token class-name">MockHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    catService <span class="token operator">=</span> <span class="token class-name">CatService</span><span class="token punctuation">(</span>httpClient<span class="token punctuation">:</span> httpClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我准备做的第一个测试是检查构造函数是否不需要httpClient。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'constructor'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'does not required a httpClient'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token class-name">CatService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isNotNull<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在我打算创建一个小组，让所有的测试得到一只随机的猫。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'catSearch'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在这个组里面，我需要检查不同的东西。</p><ol><li>当服务做了一个正确的HTTP请求但主体是空的。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">test</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">'make correct http request with empty response,'</span></span>
          <span class="token string-literal"><span class="token string">' throw [ErrorEmptyResponse]'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token class-name">MockResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> httpClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">fail</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'should throw error empty body'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">expect</span><span class="token punctuation">(</span>
            error<span class="token punctuation">,</span>
            isA<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ErrorEmptyResponse</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">verify</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> httpClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
            <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>
                <span class="token string-literal"><span class="token string">'https://api.thecatapi.com/v1/images/search?has_breeds=true'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">called</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>当服务抛出一个错误时，响应不是200。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'throws ResultError on non-200 response'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token class-name">MockResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> httpClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>
    catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">throwsA</span><span class="token punctuation">(</span>
      isA<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ErrorSearchingCat</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>当服务在一个有效的响应上返回一个Cat.json。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'return Cat.json on a valid response'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token class-name">MockResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">TestHelper</span><span class="token punctuation">.</span>searchCatJsonResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> httpClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>
          <span class="token class-name">Cat</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span><span class="token function">jsonDecode</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          isA<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cat</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你运行所有这些测试，你将得到最好的一句话：所有的测试都通过了！。</p><img src="/How-can-I-start-with-Flutter-Testing/9.png" title="示意图 width=400"><p>这里是一个完整的类。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:convert'</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/model/cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/model/result_error.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/service.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/utils/test_helper.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_test/flutter_test.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:http/http.dart'</span></span> <span class="token operator">as</span> http<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:mocktail/mocktail.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MockHttp</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">http<span class="token punctuation">.</span></span>Client</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MockResponse</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">http<span class="token punctuation">.</span></span>Response</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FakeUri</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">Uri</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Service'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    late <span class="token class-name">CatService</span> catService<span class="token punctuation">;</span>
    late <span class="token class-name">MockHttp</span> httpClient<span class="token punctuation">;</span>

    <span class="token function">setUpAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">FakeUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      httpClient <span class="token operator">=</span> <span class="token class-name">MockHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      catService <span class="token operator">=</span> <span class="token class-name">CatService</span><span class="token punctuation">(</span>httpClient<span class="token punctuation">:</span> httpClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'constructor'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'does not required a httpClient'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token class-name">CatService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isNotNull<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'catSearch'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">test</span><span class="token punctuation">(</span>
          <span class="token string-literal"><span class="token string">'make correct http request with empty response,'</span></span>
          <span class="token string-literal"><span class="token string">' throw [ErrorEmptyResponse]'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token class-name">MockResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> httpClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">fail</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'should throw error empty body'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">expect</span><span class="token punctuation">(</span>
            error<span class="token punctuation">,</span>
            isA<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ErrorEmptyResponse</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">verify</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> httpClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
            <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>
                <span class="token string-literal"><span class="token string">'https://api.thecatapi.com/v1/images/search?has_breeds=true'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">called</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'throws ResultError on non-200 response'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token class-name">MockResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> httpClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>
          catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">throwsA</span><span class="token punctuation">(</span>
            isA<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ErrorSearchingCat</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'return Cat.json on a valid response'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token class-name">MockResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token class-name">TestHelper</span><span class="token punctuation">.</span>searchCatJsonResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> httpClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>
          <span class="token class-name">Cat</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span><span class="token function">jsonDecode</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          isA<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cat</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在是时候对版本库类进行测试了。这里是cat_respository类。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'model/cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'service.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CatRepository</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">CatRepository</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">CatService</span> service<span class="token punctuation">;</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cat</span><span class="token punctuation">&gt;</span></span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> service<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先，我创建了必要的模拟</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">MockService</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">cat_service<span class="token punctuation">.</span></span>CatService</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>第二，我创建了一个组，拥有与这个类相关的所有测试。这里是创建所需变量并将其初始化到setUp方法的地方。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Cat Repository'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    late <span class="token class-name"><span class="token namespace">cat_service<span class="token punctuation">.</span></span>CatService</span> catService<span class="token punctuation">;</span>
    late <span class="token class-name">CatRepository</span> catRepository<span class="token punctuation">;</span>
    <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      catService <span class="token operator">=</span> <span class="token class-name">MockService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      catRepository <span class="token operator">=</span> <span class="token class-name">CatRepository</span><span class="token punctuation">(</span>service<span class="token punctuation">:</span> catService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来，我为构造函数创建了一个测试，在这里我检查了cat服务是否需要。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'instantiates CatRepository with a required carService'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                         
   <span class="token function">expect</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">,</span> isNotNull<span class="token punctuation">)</span><span class="token punctuation">;</span>                                  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>完成这个类的所有覆盖的其他检查:</p><ol><li>对搜索方法的调用。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'calls search method'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> catRepository<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">called</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>当搜索方法失败时抛出错误。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'throws Result exception when search fails'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// first create a exception mock instance</span>
    <span class="token keyword">final</span> exception <span class="token operator">=</span> <span class="token class-name">ErrorSearchingCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// when calls and api and throw an exception</span>
    <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenThrow</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// then expect an error result</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepository<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">throwsA</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下就是cat_repository_test.dart类的代码。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/cat_repository.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/model/result_error.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/service.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_test/flutter_test.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:mocktail/mocktail.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MockService</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name">CatService</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Cat Repository'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    late <span class="token class-name">CatService</span> catService<span class="token punctuation">;</span>
    late <span class="token class-name">CatRepository</span> catRepository<span class="token punctuation">;</span>

    <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      catService <span class="token operator">=</span> <span class="token class-name">MockService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      catRepository <span class="token operator">=</span> <span class="token class-name">CatRepository</span><span class="token punctuation">(</span>service<span class="token punctuation">:</span> catService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'constructor'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'instantiates CatRepository with a required carService'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">,</span> isNotNull<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'search next cat'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'calls search method'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> catRepository<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">called</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'throws Result exception when search fails'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token comment">// first create a exception mock instance</span>
        <span class="token keyword">final</span> exception <span class="token operator">=</span> <span class="token class-name">ErrorSearchingCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// when calls and api and throw an exception</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenThrow</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// then expect an error result</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepository<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">throwsA</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有测试都通过了!</p><img src="/How-can-I-start-with-Flutter-Testing/10.png" title="示意图 width=400"><p>酷! 现在我们已经把所有的测试都传到了我们的服务和资源库中，现在是时候进入bloc测试了。</p><h3 id="Bloc-Test"><a href="#Bloc-Test" class="headerlink" title="Bloc Test"></a>Bloc Test</h3><h4 id="random-cat-bloc-test-dart"><a href="#random-cat-bloc-test-dart" class="headerlink" title="random_cat_bloc_test.dart"></a>random_cat_bloc_test.dart</h4><p>首先，这是random_cat_bloc类。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:equatable/equatable.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_bloc/flutter_bloc.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'../../random_cat.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">part</span> <span class="token string-literal"><span class="token string">'random_cat_state.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">part</span> <span class="token string-literal"><span class="token string">'random_cat_event.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RandomCatBloc</span> <span class="token keyword">extends</span> <span class="token class-name">Bloc</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatEvent</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token keyword">this</span><span class="token punctuation">.</span>catRepository<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">on</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> emit<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_mapSearchEventToState</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> emit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">final</span> <span class="token class-name">CatRepository</span> catRepository<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">_mapSearchEventToState</span><span class="token punctuation">(</span>
      <span class="token class-name">SearchRandomCat</span> event<span class="token punctuation">,</span> <span class="token class-name">Emitter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span> emit<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">emit</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> cat <span class="token operator">=</span> <span class="token keyword">await</span> catRepository<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cat<span class="token punctuation">.</span>breeds <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> cat<span class="token punctuation">.</span>breeds<span class="token operator">!</span><span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>cat<span class="token punctuation">:</span> cat<span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emit</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>failure<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这种类型的测试中，语法与单元测试有一点不同，但它的理念是一样的。以下是关于如何在flutter中测试Bloc的官方文档：<a target="_blank" rel="noopener" href="https://bloclibrary.dev/#/testing">Bloc状态管理库</a></p><p>我按照这个文档，我得到了运行我自己的bloc测试。</p><p>让我们开始吧! 🙌<br>像往常一样，我们需要做的第一步是创建需要的模拟类。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">MockRepository</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name">CatRepository</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MockCat</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name">Cat</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>接下来，我们需要创建并初始化所需的变量给我们的模拟类。<br>此外，我还创建了第一个测试，以检查该集团的初始状态是否为 <em>RandomCatStatus.initial</em>。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'RandomCatBloc'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  late <span class="token class-name"><span class="token namespace">catRepository<span class="token punctuation">.</span></span>CatRepository</span> catRepositoryMock<span class="token punctuation">;</span>
  late <span class="token class-name"><span class="token namespace">cat<span class="token punctuation">.</span></span>Cat</span> catMock<span class="token punctuation">;</span>

  <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    catRepositoryMock <span class="token operator">=</span> <span class="token class-name">MockRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    catMock <span class="token operator">=</span> <span class="token class-name">MockCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'initial state of the bloc is [RandomCatStatus.initial]'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span>
      <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在我们可以开始进行我们的bloc测试。<br>当品种列表为空时，执行RandomCatStatus.loading和RandomCatStatus.emptyBreeds。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">blocTest<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
  <span class="token string-literal"><span class="token string">'emits [RandomCatStatus.loading, RandomCatStatus.emptyBreeds] '</span></span>
  <span class="token string-literal"><span class="token string">'state when cat.breeds are empty'</span></span><span class="token punctuation">,</span>
  setUp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">.</span>breeds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepositoryMock<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  build<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
  act<span class="token punctuation">:</span> <span class="token punctuation">(</span>bloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> bloc<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  expect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
    <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>当品种列表为空时，发出RandomCatStatus.loading和RandomCatStatus.emptyBreeds。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">blocTest<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
  <span class="token string-literal"><span class="token string">'emits [RandomCatStatus.loading, RandomCatStatus.emptyBreeds] '</span></span>
  <span class="token string-literal"><span class="token string">'state when cat.breeds are null'</span></span><span class="token punctuation">,</span>
  setUp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">.</span>breeds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepositoryMock<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  build<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
  act<span class="token punctuation">:</span> <span class="token punctuation">(</span>bloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> bloc<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  expect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
    <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>当响应正确且猫的数据包含品类时，发出RandomCatStatus.loading和RandomCatStatus.success。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">blocTest<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
     <span class="token string-literal"><span class="token string">'emits [RandomCatStatus.loading, RandomCatStatus.success]'</span></span>
     <span class="token string-literal"><span class="token string">' with a copyWith of other cat'</span></span>
     <span class="token string-literal"><span class="token string">'state for successful'</span></span><span class="token punctuation">,</span>
     setUp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">.</span>breeds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
         <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>
           <span class="token number">1</span><span class="token punctuation">,</span>
           <span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">const</span> <span class="token class-name">Breed</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'1'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepositoryMock<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     build<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
     act<span class="token punctuation">:</span> <span class="token punctuation">(</span>bloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> bloc<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     expect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
       <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>success<span class="token punctuation">,</span> cat<span class="token punctuation">:</span> catMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>当不成功时发出RandomCatStatus.loading和RandomCatStatus.failation。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">blocTest<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
  <span class="token string-literal"><span class="token string">'emits [RandomCatStatus.loading, RandomCatStatus.failure] '</span></span>
  <span class="token string-literal"><span class="token string">'when unsuccessful'</span></span><span class="token punctuation">,</span>
  setUp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>    catRepositoryMock<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenThrow</span><span class="token punctuation">(</span><span class="token class-name">ErrorSearchingCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  build<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
  act<span class="token punctuation">:</span> <span class="token punctuation">(</span>bloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> bloc<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  expect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
    <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>failure<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来看看全部的random_cat_bloc_test类!</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:bloc_test/bloc_test.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/cat_repository.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/model/cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/ui/random_cat/random_cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_test/flutter_test.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:mocktail/mocktail.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MockRepository</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name">CatRepository</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MockCat</span> <span class="token keyword">extends</span> <span class="token class-name">Mock</span> <span class="token keyword">implements</span> <span class="token class-name">Cat</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'RandomCatBloc'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    late <span class="token class-name">CatRepository</span> catRepositoryMock<span class="token punctuation">;</span>
    late <span class="token class-name">Cat</span> catMock<span class="token punctuation">;</span>

    <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      catRepositoryMock <span class="token operator">=</span> <span class="token class-name">MockRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      catMock <span class="token operator">=</span> <span class="token class-name">MockCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'initial state of the bloc is [RandomCatStatus.initial]'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span>
          <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    blocTest<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      <span class="token string-literal"><span class="token string">'emits [RandomCatStatus.loading, RandomCatStatus.emptyBreeds] '</span></span>
      <span class="token string-literal"><span class="token string">'state when cat.breeds are empty'</span></span><span class="token punctuation">,</span>
      setUp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">.</span>breeds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepositoryMock<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      build<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
      act<span class="token punctuation">:</span> <span class="token punctuation">(</span>bloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> bloc<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      expect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    blocTest<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      <span class="token string-literal"><span class="token string">'emits [RandomCatStatus.loading, RandomCatStatus.emptyBreeds] '</span></span>
      <span class="token string-literal"><span class="token string">'state when cat.breeds are null'</span></span><span class="token punctuation">,</span>
      setUp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">.</span>breeds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepositoryMock<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      build<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
      act<span class="token punctuation">:</span> <span class="token punctuation">(</span>bloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> bloc<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      expect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    blocTest<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      <span class="token string-literal"><span class="token string">'emits [RandomCatStatus.loading, RandomCatStatus.success]'</span></span>
      <span class="token string-literal"><span class="token string">' with a copyWith of other cat'</span></span>
      <span class="token string-literal"><span class="token string">'state for successful'</span></span><span class="token punctuation">,</span>
      setUp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">.</span>breeds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
          <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>
            <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">const</span> <span class="token class-name">Breed</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'1'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepositoryMock<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAnswer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      build<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
      act<span class="token punctuation">:</span> <span class="token punctuation">(</span>bloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> bloc<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      expect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>success<span class="token punctuation">,</span> cat<span class="token punctuation">:</span> catMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    blocTest<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      <span class="token string-literal"><span class="token string">'emits [RandomCatStatus.loading, RandomCatStatus.failure] '</span></span>
      <span class="token string-literal"><span class="token string">'when unsuccessful'</span></span><span class="token punctuation">,</span>
      setUp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> catRepositoryMock<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenThrow</span><span class="token punctuation">(</span><span class="token class-name">ErrorSearchingCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      build<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>catRepository<span class="token punctuation">:</span> catRepositoryMock<span class="token punctuation">)</span><span class="token punctuation">,</span>
      act<span class="token punctuation">:</span> <span class="token punctuation">(</span>bloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> bloc<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      expect<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>failure<span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此外，你可以测试你的应用程序的状态和事件。<br>下面是random_cat_state_test.dart。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_test/flutter_test.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/ui/random_cat/random_cat.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'RandomCatStatusX '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'returns correct values for RandomCatStatus.initial'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>initial<span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isInitial<span class="token punctuation">,</span> isTrue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isLoading<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isSuccess<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isFailure<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isEmptyBreeds<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'returns correct values for RandomCatStatus.loading'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isInitial<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isLoading<span class="token punctuation">,</span> isTrue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isSuccess<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isFailure<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isEmptyBreeds<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'returns correct values for RandomCatStatus.isSuccess'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>success<span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isInitial<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isLoading<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isSuccess<span class="token punctuation">,</span> isTrue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isFailure<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isEmptyBreeds<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'returns correct values for RandomCatStatus.isFailure'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>failure<span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isInitial<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isLoading<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isSuccess<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isFailure<span class="token punctuation">,</span> isTrue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isEmptyBreeds<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'returns correct values for RandomCatStatus.isEmptyBreeds'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isInitial<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isLoading<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isSuccess<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isFailure<span class="token punctuation">,</span> isFalse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isEmptyBreeds<span class="token punctuation">,</span> isTrue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里是random_cat_event_test.dart。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/ui/random_cat/random_cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_test/flutter_test.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'RandomCatEvent'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'supports comparisons'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token class-name">RandomCatEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'SearchRandomCat'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">test</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'supports comparisons'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有测试都通过了!</p><img src="/How-can-I-start-with-Flutter-Testing/11.png" title="示意图 width=400"><p>现在我们已经完成了单元测试和模块测试的部分，是时候开始进行Widget测试了!</p><h3 id="Widget测试"><a href="#Widget测试" class="headerlink" title="Widget测试"></a>Widget测试</h3><p>这种测试是超级酷的，你可以测试用户与应用程序的可能互动，所以你可以完全控制你的应用程序的所有状态。<br>在这种情况下，Widget测试将是很容易的。✌️<br>让我们开始吧!<br>首先，我们需要测试我们的random_cat_page。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/ui/random_cat/pages/bloc/random_cat_bloc.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/ui/random_cat/pages/random_cat_layout.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/cat_repository.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/repository/service.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_bloc/flutter_bloc.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RandomCatPage</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">RandomCatPage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">RepositoryProvider</span><span class="token punctuation">(</span>
      create<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">CatRepository</span><span class="token punctuation">(</span>service<span class="token punctuation">:</span> <span class="token class-name">CatService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">BlocProvider</span><span class="token punctuation">(</span>
        create<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RandomCatBloc</span><span class="token punctuation">(</span>
          catRepository<span class="token punctuation">:</span> context<span class="token punctuation">.</span>read<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CatRepository</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样，我们需要创建假的类。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">FakeRandomCatState</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">RandomCatState</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FakeRandomCatEvent</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">RandomCatEvent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后我们需要在setUpAll方法中注册。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">setUpAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">RandomCatEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">FakeRandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在这种情况下，我们只需要测试页面的渲染是否正常。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'RandomCatPage '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testWidgets</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'renders RandomCatPage'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
          home<span class="token punctuation">:</span> <span class="token class-name">RandomCatPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byType</span><span class="token punctuation">(</span><span class="token class-name">RandomCatPage</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>来看下完整的程序</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/ui/random_cat/random_cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_test/flutter_test.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:mocktail/mocktail.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:network_image_mock/network_image_mock.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">FakeRandomCatState</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">RandomCatState</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FakeRandomCatEvent</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">RandomCatEvent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setUpAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">RandomCatEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">FakeRandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'RandomCatPage '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">testWidgets</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'renders RandomCatPage'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
            home<span class="token punctuation">:</span> <span class="token class-name">RandomCatPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byType</span><span class="token punctuation">(</span><span class="token class-name">RandomCatPage</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有测试都通过了!</p><img src="/How-can-I-start-with-Flutter-Testing/12.png" title="示意图 width=400"><p>下一个我们需要测试的类是：Random_cat_layout_test.dart。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'../random_cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'bloc/random_cat_bloc.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_bloc/flutter_bloc.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RandomCatLayout</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">BlocConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      listener<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isEmptyBreeds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          context<span class="token punctuation">.</span>read<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isFailure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">const</span> <span class="token class-name">FailureRandomCatView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isInitial<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">const</span> <span class="token class-name">InitialRandomCatView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">const</span> <span class="token class-name">LoadingView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token class-name">SuccessRandomCatView</span><span class="token punctuation">(</span>
            cat<span class="token punctuation">:</span> state<span class="token punctuation">.</span>cat<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">const</span> <span class="token class-name">SizedBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里我根据视图的状态创建了不同类型的视图。要测试这些视图，最重要的部分是Key。<br>按状态划分的视图。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'../../../utils/const_keys_app.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>

<span class="token comment">// Initial</span>

<span class="token keyword">class</span> <span class="token class-name">InitialRandomCatView</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">InitialRandomCatView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">const</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
      key<span class="token punctuation">:</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatInitial</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'No information available'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Loading</span>

<span class="token keyword">class</span> <span class="token class-name">LoadingView</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">LoadingView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">const</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
      key<span class="token punctuation">:</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.CatLoading</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">CircularProgressIndicator</span><span class="token punctuation">(</span>color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>green<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Failure</span>

<span class="token keyword">class</span> <span class="token class-name">FailureRandomCatView</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">FailureRandomCatView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">const</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
      key<span class="token punctuation">:</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatFailure</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Something was wrong'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Success</span>

<span class="token keyword">class</span> <span class="token class-name">SuccessRandomCatView</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">SuccessRandomCatView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>cat<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> <span class="token class-name">Cat</span> cat<span class="token punctuation">;</span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
      key<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatSuccess</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token class-name">Padding</span><span class="token punctuation">(</span>
          padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">only</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> <span class="token number">28.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          child<span class="token punctuation">:</span> <span class="token class-name">CatCard</span><span class="token punctuation">(</span>
            key<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatCardKey</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            cat<span class="token punctuation">:</span> cat<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token class-name">Spacer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Padding</span><span class="token punctuation">(</span>
          padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">only</span><span class="token punctuation">(</span>right<span class="token punctuation">:</span> <span class="token number">18.0</span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token number">8.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          child<span class="token punctuation">:</span> <span class="token class-name">Align</span><span class="token punctuation">(</span>
            alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>bottomRight<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token class-name">FloatingActionButton</span><span class="token punctuation">(</span>
              key<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatFabButtonKey</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              onPressed<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
                context<span class="token punctuation">.</span>read<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>refresh<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个类有更多的测试要做。这里我们有不同的状态和一个按钮的交互，所以让我们开始吧。<br>首先，我们需要模拟和假的类。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">MockRandomCatBloc</span> <span class="token keyword">extends</span> <span class="token class-name">MockBloc</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatEvent</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">RandomCatBloc</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FakeRandomCatState</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">RandomCatState</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FakeRandomCatEvent</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">RandomCatEvent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后我们需要创建和初始化变量。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">late <span class="token class-name">MockRandomCatBloc</span> blocCat<span class="token punctuation">;</span>

<span class="token function">setUpAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Register the event and the state</span>
  <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">FakeRandomCatEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">FakeRandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  blocCat <span class="token operator">=</span> <span class="token class-name">MockRandomCatBloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们要测试的第一件事是视图的可能状态，为了做到这一点，我们要创建一个特定的组，然后在里面，我们可以测试所有情况。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'RandomCatPage states '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>当状态为RandomCatStatus.failure时，渲染视图FailureRandomCatView。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">testWidgets</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">'render FailureRandomCatView when state is [RandomCatStatus.failure]'</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>failure<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatFailure</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>当状态为RandomCatStatus.loading时，渲染视图LoadingView。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">testWidgets</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">'render LoadingView when state is [RandomCatStatus.loading]'</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>
          find<span class="token punctuation">.</span><span class="token function">byKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.CatLoading</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>当状态为RandomCatStatus.success时，渲染视图SuccessRandomCatView。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">testWidgets</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">'render SuccessRandomCatView when state is [RandomCatStatus.success]'</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatSuccess</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>当状态为RandomCatStatus.initial时，渲染视图InitialRandomCatView。</li></ol><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">testWidgets</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">'render InitialRandomCatView when state is [RandomCatStatus.initial]'</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>initial<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatInitial</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>酷😎! 现在我们已经测试了视图的所有可能状态，我们可以开始下一步了。测试按钮的点击!<br>当按钮被点击的时候，调用事件SearchRandomCat。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Click on FAB '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">testWidgets</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'call to bloc to get next cat'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
     <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
       <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
       <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
         <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
           lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
           create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
           child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
             home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byType</span><span class="token punctuation">(</span><span class="token class-name">FloatingActionButton</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">await</span> tester<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byType</span><span class="token punctuation">(</span><span class="token class-name">FloatingActionButton</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">await</span> tester<span class="token punctuation">.</span><span class="token function">pumpAndSettle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">called</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，我们需要控制猫的品种为空的时候。<br>我们在BlocConsumer里面监听，所以如果发生这种情况，我们需要再次调用SearchRandomCat事件，为了测试，我们需要做以下工作。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Call to SearchRandomCat on BlocListener '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cat <span class="token operator">=</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'1'</span></span><span class="token punctuation">,</span> breeds<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'www'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">testWidgets</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Call to event when breeds is empty'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">whenListen</span><span class="token punctuation">(</span>
        blocCat<span class="token punctuation">,</span>
        <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span>
          <span class="token punctuation">[</span>
            <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">,</span> cat<span class="token punctuation">:</span> cat<span class="token punctuation">)</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">,</span> cat<span class="token punctuation">:</span> cat<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">called</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>来看完整的程序</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:bloc_test/bloc_test.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/ui/random_cat/random_cat.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:catsapp/utils/const_keys_app.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_bloc/flutter_bloc.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_test/flutter_test.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:mocktail/mocktail.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:network_image_mock/network_image_mock.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MockRandomCatBloc</span> <span class="token keyword">extends</span> <span class="token class-name">MockBloc</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatEvent</span><span class="token punctuation">,</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">RandomCatBloc</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FakeRandomCatState</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">RandomCatState</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FakeRandomCatEvent</span> <span class="token keyword">extends</span> <span class="token class-name">Fake</span> <span class="token keyword">implements</span> <span class="token class-name">RandomCatEvent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  late <span class="token class-name">MockRandomCatBloc</span> blocCat<span class="token punctuation">;</span>

  <span class="token function">setUpAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Register the event and the state</span>
    <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">FakeRandomCatEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerFallbackValue</span><span class="token punctuation">(</span><span class="token class-name">FakeRandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    blocCat <span class="token operator">=</span> <span class="token class-name">MockRandomCatBloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'RandomCatPage states '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">testWidgets</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">'render FailureRandomCatView when state is [RandomCatStatus.failure]'</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>failure<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatFailure</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">testWidgets</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'render LoadingView when state is [RandomCatStatus.loading]'</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>
          find<span class="token punctuation">.</span><span class="token function">byKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.CatLoading</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">testWidgets</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">'render SuccessRandomCatView when state is [RandomCatStatus.success]'</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatSuccess</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">testWidgets</span><span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">'render InitialRandomCatView when state is [RandomCatStatus.initial]'</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>initial<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byKey</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">ConstWidgetKeysApp.RandomCatInitial</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Click on FAB '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">testWidgets</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'call to bloc to get next cat'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byType</span><span class="token punctuation">(</span><span class="token class-name">FloatingActionButton</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">await</span> tester<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byType</span><span class="token punctuation">(</span><span class="token class-name">FloatingActionButton</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> tester<span class="token punctuation">.</span><span class="token function">pumpAndSettle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">called</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Call to SearchRandomCat on BlocListener '</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cat <span class="token operator">=</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'1'</span></span><span class="token punctuation">,</span> breeds<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'www'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">testWidgets</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Call to event when breeds is empty'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
      <span class="token function">whenListen</span><span class="token punctuation">(</span>
        blocCat<span class="token punctuation">,</span>
        <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span>
          <span class="token punctuation">[</span>
            <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">,</span> cat<span class="token punctuation">:</span> cat<span class="token punctuation">)</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">RandomCatState</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token class-name">RandomCatStatus</span><span class="token punctuation">.</span>emptyBreeds<span class="token punctuation">,</span> cat<span class="token punctuation">:</span> cat<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">mockNetworkImagesFor</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span>
          <span class="token class-name">BlocProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RandomCatBloc</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            lazy<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            create<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">MaterialApp</span><span class="token punctuation">(</span>
              home<span class="token punctuation">:</span> <span class="token class-name">RandomCatLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> blocCat<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SearchRandomCat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">called</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有测试都通过了!</p><img src="/How-can-I-start-with-Flutter-Testing/13.png" title="示意图 width=400"><p>我们要做的最后一步是检查保险。你有不同的选择。</p><ul><li>在终端上运行flutter测试–覆盖率。</li><li>安装LCOV以实现HTML的可视化<br>我使用了第二个选项，所以我将告诉你如何安装和使用它。(mac的安装)。</li><li>brew install lcov</li><li>flutter test — coverage</li><li>genhtml coverage/lcov.info -o coverage/html<br>最后，你将会看到我们的应用程序100%的覆盖率🧪✌️。</li></ul><img src="/How-can-I-start-with-Flutter-Testing/14.png" title="示意图 width=400"><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>我认为一开始学习测试可能会很困难和令人沮丧，但你应该学习它，因为如果你想建立好的应用程序，你需要了解测试的工作原理。在我第一次接触它的时候，我解决了很多bug，如果我没有做测试，这些bug就会存在。<br>所以……请做测试!</p><p>以上所有源代码，您可以移步：<a target="_blank" rel="noopener" href="https://github.com/reasonpun/my_100_goals/tree/main/goals_01">https://github.com/reasonpun/my_100_goals/tree/main/goals_01</a></p></div><footer class="post-footer"><div class="reward-container"><div>你的鼓励是我更新的动力！</div><button>赞赏</button><div class="post-reward"><div><img src="/images/wechatpay.png" alt="木辛念做梓 微信"> <span>微信</span></div><div><img src="/images/alipay.png" alt="木辛念做梓 支付宝"> <span>支付宝</span></div></div></div><div class="post-tags"><a href="/tags/Flutter/" rel="tag"># Flutter</a> <a href="/tags/CI-CD/" rel="tag"># CI/CD</a></div><div class="post-nav"><div class="post-nav-item"><a href="/Deep-Drive-into-Flutter-Lifecycle.html" rel="prev" title="深入了解 Flutter 生命周期"><i class="fa fa-chevron-left"></i> 深入了解 Flutter 生命周期</a></div><div class="post-nav-item"><a href="/Breakdown-setState-signature.html" rel="next" title="浅析setState()">浅析setState() <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">木辛念做梓</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">534k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">8:06</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script></body></html>