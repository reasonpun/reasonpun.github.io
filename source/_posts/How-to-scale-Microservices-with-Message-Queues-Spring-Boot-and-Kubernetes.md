---
title: å¦‚ä½•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ã€Spring Boot å’Œ Kubernetes æ‰©å±•å¾®æœåŠ¡
date: 2022-03-24 11:03:50
categories:
- SpringBoot
tags:
- SprintBoot
- Java
- Kubernetes
---


{% asset_img 1.png ç¤ºæ„å›¾ width="400" %}

å½“æ‚¨å¤§è§„æ¨¡è®¾è®¡å’Œæ„å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨å°†é¢ä¸´ä¸¤ä¸ªé‡å¤§æŒ‘æˆ˜ï¼šå¯æ‰©å±•æ€§å’Œç¨³å¥æ€§ã€‚
æ‚¨åº”è¯¥è®¾è®¡æ‚¨çš„æœåŠ¡ï¼Œä»¥ä¾¿å³ä½¿å®ƒå—åˆ°é—´æ­‡æ€§é‡è´Ÿè½½çš„å½±å“ï¼Œå®ƒä¹Ÿèƒ½ç»§ç»­å¯é åœ°è¿è¡Œã€‚
ä»¥ Apple Store ä¸ºä¾‹ã€‚
æ¯å¹´éƒ½æœ‰æ•°ç™¾ä¸‡ Apple å®¢æˆ·é¢„å…ˆæ³¨å†Œè´­ä¹°æ–° iPhoneã€‚
æ•°ç™¾ä¸‡äººåŒæ—¶è´­ä¹°ä¸€ä»¶å•†å“ã€‚

<!--more-->

å¦‚æœæ‚¨å°† Apple å•†åº—çš„æµé‡æç»˜ä¸ºéšæ—¶é—´å˜åŒ–çš„æ¯ç§’è¯·æ±‚æ•°ï¼Œå›¾è¡¨å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

{% asset_img 2.png ç¤ºæ„å›¾ width="400" %}

ç°åœ¨æƒ³è±¡ä¸€ä¸‹ï¼Œä½ çš„ä»»åŠ¡æ˜¯æ„å»ºè¿™æ ·çš„åº”ç”¨ç¨‹åºã€‚
æ‚¨æ­£åœ¨å»ºç«‹ä¸€ä¸ªå•†åº—ï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸­è´­ä¹°ä»–ä»¬æœ€å–œæ¬¢çš„å•†å“ã€‚
æ‚¨æ„å»ºä¸€ä¸ªå¾®æœåŠ¡æ¥å‘ˆç°ç½‘é¡µå¹¶æä¾›é™æ€èµ„äº§ã€‚ æ‚¨è¿˜æ„å»ºäº†ä¸€ä¸ªåç«¯ REST API æ¥å¤„ç†ä¼ å…¥çš„è¯·æ±‚ã€‚
æ‚¨å¸Œæœ›å°†è¿™ä¸¤ä¸ªç»„ä»¶åˆ†å¼€ï¼Œå› ä¸ºä½¿ç”¨ç›¸åŒçš„ REST APIï¼Œæ‚¨å¯ä»¥ä¸ºç½‘ç«™å’Œç§»åŠ¨åº”ç”¨ç¨‹åºæä¾›æœåŠ¡ã€‚

{% asset_img 3.gif ç¤ºæ„å›¾ width="400" %}

(å¼€å§‹æƒ³è±¡)
ä»Šå¤©æ˜¯å¤§æ—¥å­ï¼Œä½ çš„å•†åº—ä¸Šçº¿äº†ã€‚
æ‚¨å†³å®šå°†åº”ç”¨ç¨‹åºæ‰©å±•åˆ°å››ä¸ªå‰ç«¯å®ä¾‹å’Œå››ä¸ªåç«¯å®ä¾‹ï¼Œå› ä¸ºæ‚¨é¢„æµ‹è¯¥ç½‘ç«™å°†æ¯”å¹³æ—¶æ›´ç¹å¿™ã€‚

{% asset_img 4.gif ç¤ºæ„å›¾ width="400" %}

æ‚¨å¼€å§‹æ”¶åˆ°è¶Šæ¥è¶Šå¤šçš„æµé‡ã€‚
å‰ç«¯æœåŠ¡æ­£åœ¨å¤„ç†æµé‡ã€‚ ä½†æ˜¯æ‚¨æ³¨æ„åˆ°è¿æ¥åˆ°æ•°æ®åº“çš„åç«¯æ­£åœ¨åŠªåŠ›è·Ÿä¸Šäº‹åŠ¡çš„æ•°é‡ã€‚
ä¸ç”¨æ‹…å¿ƒï¼Œæ‚¨å¯ä»¥å°†åç«¯çš„å‰¯æœ¬æ•°æ‰©å±•åˆ° 8 ä¸ªã€‚

{% asset_img 5.gif ç¤ºæ„å›¾ width="400" %}

æ‚¨æ”¶åˆ°çš„æµé‡æ›´å¤šäº†ï¼Œè€Œåç«¯å´æ— æ³•åº”å¯¹ã€‚
ä¸€äº›æœåŠ¡å¼€å§‹æ–­å¼€è¿æ¥ã€‚ æ„¤æ€’çš„å®¢æˆ·å¼€å§‹è”ç³»ä½ çš„å®¢æœæŠ±ï¼ˆliaoï¼‰æ€¨ï¼ˆtianï¼‰ã€‚ 
æ‚¨çš„åç«¯è¶Šæ¥è¶Šä¹åŠ›ï¼Œå¹¶ä¸”ä¸¢å¤±äº†å¤§é‡çš„è¿æ¥ã€‚

{% asset_img 6.gif ç¤ºæ„å›¾ width="400" %}

ä½ ä¸ºæ­¤æŸå¤±äº†ä¸€å¤§ç¬”é’±ï¼Œè€Œä½ çš„å®¢æˆ·åˆ™å¾ˆä¸é«˜å…´ã€‚

æ‚¨çš„åº”ç”¨ç¨‹åºå¹¶éè®¾è®¡ä¸ºå¥å£®å’Œé«˜å¯ç”¨æ€§ï¼š
 * å‰ç«¯å’Œåç«¯æ˜¯ç´§å¯†è€¦åˆçš„â€”â€”äº‹å®ä¸Šå®ƒä¸èƒ½å¤„ç†æ²¡æœ‰åç«¯çš„åº”ç”¨ç¨‹åº
 * å‰ç«¯å’Œåç«¯å¿…é¡»ååŒæ‰©å±•â€”â€”å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„åç«¯ï¼Œä½ å¯èƒ½ä¼šæ·¹æ²¡åœ¨æµé‡ä¸­
 * å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œæ‚¨å°†æ— æ³•å¤„ç†ä¼ å…¥äº¤æ˜“ã€‚

äº¤æ˜“æŸå¤±å°±æ˜¯æ”¶å…¥æŸå¤±ã€‚
æ‰€ä»¥ï¼Œä½ ä¸ï¼ˆzaoï¼‰å¾—ï¼ˆganï¼‰ä¸ï¼ˆmaï¼‰ï¼ˆqu leï¼‰é‡æ–°è®¾è®¡ä½ çš„æ¶æ„ï¼šç”¨é˜Ÿåˆ—è§£è€¦å‰ç«¯å’Œåç«¯ã€‚

{% asset_img 7.gif ç¤ºæ„å›¾ width="400" %}

å‰ç«¯å°†æ¶ˆæ¯å‘å¸ƒåˆ°é˜Ÿåˆ—ï¼Œè€Œåç«¯åŒæ—¶å¤„ç†ä¸€æ¡å¾…å¤„ç†çš„æ¶ˆæ¯ã€‚
æ–°æ¶æ„æœ‰ä¸€äº›æ˜æ˜¾çš„å¥½å¤„ï¼š
 * å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œåˆ™é˜Ÿåˆ—å……å½“ç¼“å†²åŒº
 * å¦‚æœå‰ç«¯äº§ç”Ÿçš„æ¶ˆæ¯å¤šäºåç«¯å¯ä»¥å¤„ç†çš„æ¶ˆæ¯ï¼Œåˆ™è¿™äº›æ¶ˆæ¯å°†ç¼“å†²åœ¨é˜Ÿåˆ—ä¸­
 * æ‚¨å¯ä»¥ç‹¬ç«‹äºå‰ç«¯æ‰©å±•åç«¯ - å³æ‚¨å¯ä»¥æ‹¥æœ‰æ•°ç™¾ä¸ªå‰ç«¯æœåŠ¡å’Œä¸€ä¸ªåç«¯å®ä¾‹
å¤ªå¥½äº†ï¼Œä½†æ˜¯æ‚¨å¦‚ä½•æ„å»ºè¿™æ ·çš„åº”ç”¨ç¨‹åºï¼Ÿ
æ‚¨å¦‚ä½•è®¾è®¡å¯ä»¥å¤„ç†æ•°åä¸‡ä¸ªè¯·æ±‚çš„æœåŠ¡ï¼Ÿ 
ä»¥åŠå¦‚ä½•éƒ¨ç½²åŠ¨æ€æ‰©å±•çš„åº”ç”¨ç¨‹åºï¼Ÿ
åœ¨æ·±å…¥äº†è§£éƒ¨ç½²å’Œæ‰©å±•çš„ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå…³æ³¨åº”ç”¨ç¨‹åºã€‚

## ç¼–å†™ Spring åº”ç”¨ç¨‹åº

è¯¥æœåŠ¡åŒ…å«ä¸‰ä¸ªç»„ä»¶ï¼šå‰ç«¯ã€åç«¯å’Œæ¶ˆæ¯ä»£ç†ã€‚
å‰ç«¯æ˜¯ä¸€ä¸ªå¸¦æœ‰ Thymeleaf æ¨¡æ¿å¼•æ“çš„ç®€å• Spring Boot Web åº”ç”¨ç¨‹åºã€‚
åç«¯æ˜¯ä¸€ä¸ªä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ¶ˆæ¯çš„å·¥ä½œäººå‘˜ã€‚
ç”±äº [Spring Boot ä¸ JMS å…·æœ‰å‡ºè‰²çš„é›†æˆ](https://spring.io/guides/gs/messaging-jms/)ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥å‘é€å’Œæ¥æ”¶å¼‚æ­¥æ¶ˆæ¯ã€‚
æ‚¨å¯ä»¥åœ¨ learnk8s/spring-boot-k8s-hpa æ‰¾åˆ°ä¸€ä¸ªåŒ…å«è¿æ¥åˆ° JMS çš„å‰ç«¯å’Œåç«¯åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹é¡¹ç›®ã€‚

> è¯·æ³¨æ„ï¼Œè¯¥åº”ç”¨ç¨‹åºæ˜¯ç”¨ Java 10 ç¼–å†™çš„ï¼Œä»¥åˆ©ç”¨æ”¹è¿›çš„ Docker å®¹å™¨é›†æˆã€‚

åªéœ€è¦ä¸€ä¸ªä»£ç åº“ï¼Œæ‚¨å¯ä»¥å°†é¡¹ç›®é…ç½®ä¸ºä½œä¸ºå‰ç«¯æˆ–åç«¯è¿è¡Œã€‚
è¯¥åº”ç”¨ç¨‹åºå…·æœ‰ï¼š
 * å¯ä»¥è´­ä¹°å•†å“çš„ä¸»é¡µ
 * ä¸€ä¸ªç®¡ç†é¢æ¿ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æ£€æŸ¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°é‡
 * ä¸€ä¸ª /health ç«¯ç‚¹ï¼Œç”¨äºåœ¨åº”ç”¨ç¨‹åºå‡†å¤‡å¥½æ¥æ”¶æµé‡æ—¶å‘å‡ºä¿¡å·
 * ä¸€ä¸ª /submit ç«¯ç‚¹ï¼Œå®ƒæ¥æ”¶æ¥è‡ªè¡¨å•çš„æäº¤å¹¶åœ¨é˜Ÿåˆ—ä¸­åˆ›å»ºæ¶ˆæ¯
 * ä¸€ä¸ª /metrics ç«¯ç‚¹ï¼Œç”¨äºå…¬å¼€é˜Ÿåˆ—ä¸­å¾…å¤„ç†æ¶ˆæ¯çš„æ•°é‡ï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰
è¯¥åº”ç”¨ç¨‹åºå¯ä»¥åœ¨ä¸¤ç§æ¨¡å¼ä¸‹è¿è¡Œï¼š
**ä½œä¸ºå‰ç«¯**ï¼Œåº”ç”¨ç¨‹åºå‘ˆç°äººä»¬å¯ä»¥è´­ä¹°å•†å“çš„ç½‘é¡µã€‚

{% asset_img 8.png ç¤ºæ„å›¾ width="400" %}

ä½œä¸ºWorkerï¼Œåº”ç”¨ç¨‹åºç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å¹¶å¤„ç†å®ƒä»¬ã€‚

{% asset_img 9.png ç¤ºæ„å›¾ width="400" %}

> è¯·æ³¨æ„ï¼Œåœ¨ç¤ºä¾‹é¡¹ç›®ä¸­ï¼Œå¤„ç†æ˜¯é€šè¿‡ä½¿ç”¨ Thread.sleep(5000) ç­‰å¾…äº”ç§’é’Ÿæ¥æ¨¡æ‹Ÿçš„ã€‚

æ‚¨å¯ä»¥é€šè¿‡æ›´æ”¹ application.yaml ä¸­çš„å€¼æ¥åœ¨ä»»ä¸€æ¨¡å¼ä¸‹é…ç½®åº”ç”¨ç¨‹åºã€‚

## è®©é¡¹ç›®ç¨‹åºå…ˆç©ºè½¬ä¸€ä¼šå„¿

é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºä½œä¸ºå‰ç«¯å’ŒWorkerå¯åŠ¨ã€‚
æ‚¨å¯ä»¥è¿è¡Œè¯¥åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”åªè¦æ‚¨æœ‰ä¸€ä¸ªæœ¬åœ°è¿è¡Œçš„ ActiveMQ å®ä¾‹ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿè´­ä¹°ç‰©å“å¹¶è®©ç³»ç»Ÿå¤„ç†è¿™äº›ç‰©å“ã€‚

{% asset_img 10.gif ç¤ºæ„å›¾ width="400" %}

å¦‚æœæ‚¨æ£€æŸ¥æ—¥å¿—ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°workeræ­£åœ¨å¤„ç†é¡¹ç›®ã€‚
å®Œç¾ï¼ ç¼–å†™ Spring Boot åº”ç”¨ç¨‹åºå¾ˆå®¹æ˜“ã€‚
ä¸€ä¸ªæ›´æœ‰è¶£çš„ä¸»é¢˜æ˜¯å­¦ä¹ å¦‚ä½•å°† Spring Boot è¿æ¥åˆ°æ¶ˆæ¯ä»£ç†ã€‚

## ä½¿ç”¨ JMS å‘é€å’Œæ¥æ”¶æ¶ˆæ¯
Spring JMSï¼ˆJava æ¶ˆæ¯æœåŠ¡ï¼‰æ˜¯ä¸€ç§ä½¿ç”¨æ ‡å‡†åè®®å‘é€å’Œæ¥æ”¶æ¶ˆæ¯çš„å¼ºå¤§æœºåˆ¶ã€‚
å¦‚æœæ‚¨è¿‡å»ä½¿ç”¨è¿‡ JDBC APIï¼Œæ‚¨åº”è¯¥ä¼šå‘ç° JMS API å¾ˆç†Ÿæ‚‰ï¼Œå› ä¸ºå®ƒçš„å·¥ä½œæ–¹å¼ç±»ä¼¼ã€‚
æ‚¨å¯ä»¥ä¸ JMS ä¸€èµ·ä½¿ç”¨çš„æœ€æµè¡Œçš„æ¶ˆæ¯ä»£ç†æ˜¯ ActiveMQ â€” ä¸€ä¸ªå¼€æºæ¶ˆæ¯ä¼ é€’æœåŠ¡å™¨ã€‚
ä½¿ç”¨è¿™ä¸¤ä¸ªç»„ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç†Ÿæ‚‰çš„æ¥å£ (JMS) å°†æ¶ˆæ¯å‘å¸ƒåˆ°é˜Ÿåˆ— (ActiveMQ)ï¼Œå¹¶ä½¿ç”¨ç›¸åŒçš„æ¥å£æ¥æ”¶æ¶ˆæ¯ã€‚
æ›´æ£’çš„æ˜¯ï¼ŒSpring Boot ä¸ JMS å…·æœ‰å‡ºè‰²çš„é›†æˆï¼Œå› æ­¤æ‚¨å¯ä»¥ç«‹å³ä¸Šæ‰‹ã€‚
å®é™…ä¸Šï¼Œä¸‹é¢çš„çŸ­ç±»å°è£…äº†ç”¨äºä¸é˜Ÿåˆ—äº¤äº’çš„é€»è¾‘ï¼š

```java
@Component
public class QueueService implements MessageListener {
private static final Logger LOGGER = LoggerFactory.getLogger(QueueService.class);
@Autowired
  private JmsTemplate jmsTemplate;
  public void send(String destination, String message) {
    LOGGER.info("sending message='{}' to destination='{}'", message, destination);
    jmsTemplate.convertAndSend(destination, message);
  }
@Override
  public void onMessage(Message message) {
    if (message instanceof ActiveMQTextMessage) {
      ActiveMQTextMessage textMessage = (ActiveMQTextMessage) message;
      try {
        LOGGER.info("Processing task " + textMessage.getText());
        Thread.sleep(5000);
        LOGGER.info("Completed task " + textMessage.getText());
      } catch (InterruptedException e) {
        e.printStackTrace();
      } catch (JMSException e) {
        e.printStackTrace();
      }
    } else {
      LOGGER.error("Message is not a text message " + message.toString());
    }
  }
}
```

æ‚¨å¯ä»¥ä½¿ç”¨ send æ–¹æ³•å°†æ¶ˆæ¯å‘å¸ƒåˆ°å‘½åé˜Ÿåˆ—ã€‚
æ­¤å¤–ï¼ŒSpring Boot å°†ä¸ºæ¯æ¡ä¼ å…¥æ¶ˆæ¯æ‰§è¡Œ onMessage æ–¹æ³•ã€‚
æœ€åä¸€å—å†…å®¹è¦è¯´çš„æ˜¯æŒ‡ç¤º Spring Boot ä½¿ç”¨è¯¥ç±»ã€‚
æ‚¨å¯ä»¥é€šè¿‡åœ¨ [Spring Boot åº”ç”¨ç¨‹åºä¸­æ³¨å†Œä¾¦å¬å™¨](https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#jms-annotated-programmatic-registration)æ¥åœ¨åå°å¤„ç†æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@SpringBootApplication
@EnableJms
public class SpringBootApplication implements JmsListenerConfigurer {
  @Autowired
  private QueueService queueService;
public static void main(String[] args) {
    SpringApplication.run(SpringBootApplication.class, args);
  }
@Override
  public void configureJmsListeners(JmsListenerEndpointRegistrar registrar) {
    SimpleJmsListenerEndpoint endpoint = new SimpleJmsListenerEndpoint();
    endpoint.setId("myId");
    endpoint.setDestination("queueName");
    endpoint.setMessageListener(queueService);
    registrar.registerEndpoint(endpoint);
  }
}
```

å…¶ä¸­ id æ˜¯æ¶ˆè´¹è€…çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œdestination æ˜¯é˜Ÿåˆ—çš„åç§°ã€‚
è¯·æ³¨æ„æ‚¨æ˜¯å¦‚ä½•ç”¨ä¸åˆ° 40 è¡Œä»£ç ç¼–å†™å‡ºå¯é é˜Ÿåˆ—çš„ã€‚
ä½ ä¸€å®šä¼šçˆ±ä¸Š Spring Bootã€‚

## èŠ‚çœéƒ¨ç½²çš„æ‰€æœ‰æ—¶é—´éƒ½å¯ä»¥ä¸“æ³¨äºç¼–ç 

æ‚¨éªŒè¯äº†åº”ç”¨ç¨‹åºå·¥ä½œæ­£å¸¸ï¼Œç»ˆäºåˆ°äº†éƒ¨ç½²å®ƒçš„æ—¶å€™äº†ã€‚
æ­¤æ—¶ï¼Œæ‚¨å¯ä»¥å¯åŠ¨æ‚¨çš„ VPSï¼Œå®‰è£… Tomcatï¼Œå¹¶èŠ±ä¸€äº›æ—¶é—´ç¼–å†™è‡ªå®šä¹‰è„šæœ¬æ¥æµ‹è¯•ã€æ„å»ºã€æ‰“åŒ…å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºã€‚
æˆ–è€…æ‚¨å¯ä»¥å†™ä¸‹æ‚¨å¸Œæœ›æ‹¥æœ‰çš„å†…å®¹çš„æè¿°ï¼šä¸€ä¸ªæ¶ˆæ¯ä»£ç†å’Œä¸¤ä¸ªä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨éƒ¨ç½²çš„åº”ç”¨ç¨‹åºã€‚
Kubernetes ç­‰ç¼–æ’å™¨å¯ä»¥è¯»å–æ‚¨çš„æ¸…å•å¹¶é…ç½®æ­£ç¡®åŸºç¡€æ¶æ„ã€‚
ç”±äºåœ¨åŸºç¡€æ¶æ„ä¸ŠèŠ±è´¹çš„æ—¶é—´è¶Šå°‘ï¼Œç¼–ç æ—¶é—´å°±è¶Šå¤šï¼Œè¿™æ¬¡æ‚¨å°†æŠŠåº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetesã€‚ä½†åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦ä¸€ä¸ª Kubernetes é›†ç¾¤ã€‚
æ‚¨å¯ä»¥æ³¨å†Œ Google Cloud Platform æˆ– Azureï¼Œå¹¶ä½¿ç”¨ Kubernetes æä¾›çš„äº‘æä¾›å•†ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥åœ¨å°†åº”ç”¨ç¨‹åºè¿ç§»åˆ°äº‘ç«¯ä¹‹å‰åœ¨æœ¬åœ°å°è¯• Kubernetesã€‚
minikube æ˜¯ä¸€ä¸ªæ‰“åŒ…æˆè™šæ‹Ÿæœºçš„æœ¬åœ° Kubernetes é›†ç¾¤ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Windowsã€Linux å’Œ Macï¼Œé‚£å°±å¤ªå¥½äº†ï¼Œå› ä¸ºåˆ›å»ºä¸€ä¸ªé›†ç¾¤éœ€è¦äº”åˆ†é’Ÿã€‚
æ‚¨è¿˜åº”è¯¥å®‰è£… kubectlï¼Œç”¨äºè¿æ¥åˆ°æ‚¨çš„é›†ç¾¤çš„å®¢æˆ·ç«¯ã€‚
æ‚¨å¯ä»¥ä»[å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/tasks/tools/)ä¸­æ‰¾åˆ°æœ‰å…³å¦‚ä½•å®‰è£… minikube å’Œ kubectl çš„è¯´æ˜ã€‚

> å¦‚æœæ‚¨åœ¨ Windows ä¸Šè¿è¡Œï¼Œæ‚¨åº”è¯¥æŸ¥çœ‹æˆ‘ä»¬å…³äºå¦‚ä½•å®‰è£… Kubernetes å’Œ Docker çš„è¯¦ç»†æŒ‡å—ã€‚

æ‚¨åº”è¯¥å¯åŠ¨ä¸€ä¸ªå…·æœ‰ 8GB RAM å’Œä¸€äº›é¢å¤–é…ç½®çš„é›†ç¾¤ï¼š

```
minikube start \
  --memory 8096 \
  --extra-config=controller-manager.horizontal-pod-autoscaler-upscale-delay=1m \
  --extra-config=controller-manager.horizontal-pod-autoscaler-downscale-delay=2m \
  --extra-config=controller-manager.horizontal-pod-autoscaler-sync-period=10s
```

> è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯é¢„å…ˆå­˜åœ¨çš„ minikube å®ä¾‹ï¼Œæ‚¨å¯ä»¥é€šè¿‡é”€æ¯å®ƒå¹¶é‡æ–°åˆ›å»ºå®ƒæ¥è°ƒæ•´ VM çš„å¤§å°ã€‚ ä»…æ·»åŠ  --memory 8096 ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚

éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸã€‚ 
æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä»¥è¡¨æ ¼å½¢å¼åˆ—å‡ºçš„ä¸€äº›èµ„æºã€‚ 
é›†ç¾¤å·²å‡†å¤‡å°±ç»ªï¼Œä¹Ÿè®¸æ‚¨ç°åœ¨åº”è¯¥å¼€å§‹éƒ¨ç½²ï¼Ÿ
å…¶å®ï¼Œè¿˜ä¸å¯ä»¥ ğŸ˜‚ã€‚
ä½ è¿˜æ˜¯éœ€è¦å…ˆå‡†å¤‡ä¸€äº›ä¸œè¥¿ã€‚

éƒ¨ç½²åˆ° Kubernetes çš„åº”ç”¨ç¨‹åºå¿…é¡»æ‰“åŒ…ä¸ºå®¹å™¨ã€‚ æ¯•ç«Ÿï¼ŒKubernetes æ˜¯ä¸€ä¸ªå®¹å™¨ç¼–æ’å™¨ï¼Œæ‰€ä»¥å®ƒä¸èƒ½åŸç”Ÿè¿è¡Œä½ çš„ jarã€‚
å®¹å™¨ç±»ä¼¼äºèƒ–ç½å­ï¼šå®ƒä»¬åŒ…å«è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„æ‰€æœ‰ä¾èµ–é¡¹ã€‚ ç”šè‡³ JVM ä¹Ÿæ˜¯å®¹å™¨çš„ä¸€éƒ¨åˆ†ã€‚ æ‰€ä»¥ä»æŠ€æœ¯ä¸Šè®²ï¼Œå®ƒä»¬æ˜¯ä¸€ä¸ªæ›´èƒ–çš„èƒ–ç½å­ã€‚
å°†åº”ç”¨ç¨‹åºæ‰“åŒ…ä¸ºå®¹å™¨çš„æµè¡ŒæŠ€æœ¯æ˜¯ Dockerã€‚

> è™½ç„¶æ˜¯æœ€å—æ¬¢è¿çš„ï¼Œä½† Docker å¹¶ä¸æ˜¯å”¯ä¸€èƒ½å¤Ÿè¿è¡Œå®¹å™¨çš„æŠ€æœ¯ã€‚ å…¶ä»–æµè¡Œçš„é€‰é¡¹åŒ…æ‹¬ rkt å’Œ lxdã€‚

å¦‚æœæ‚¨æ²¡æœ‰å®‰è£… Dockerï¼Œå¯ä»¥æŒ‰ç…§ [Docker å®˜æ–¹ç½‘ç«™](https://docs.docker.com/install/)ä¸Šçš„è¯´æ˜è¿›è¡Œæ“ä½œã€‚
é€šå¸¸ï¼Œæ‚¨æ„å»ºå®¹å™¨å¹¶å°†å®ƒä»¬æ¨é€åˆ°æ³¨å†Œè¡¨ã€‚ è¿™ç±»ä¼¼äºå°† jar å‘å¸ƒåˆ° Artifactory æˆ– Nexusã€‚ ä½†åœ¨è¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œæ‚¨å°†åœ¨æœ¬åœ°å·¥ä½œå¹¶è·³è¿‡æ³¨å†Œè¡¨éƒ¨åˆ†ã€‚ å®é™…ä¸Šï¼Œæ‚¨å°†ç›´æ¥åœ¨ minikube ä¸­åˆ›å»ºå®¹å™¨é•œåƒã€‚
é¦–å…ˆï¼ŒæŒ‰ç…§æ­¤å‘½ä»¤æ‰“å°çš„è¯´æ˜å°† Docker å®¢æˆ·ç«¯è¿æ¥åˆ° minikubeï¼š

```
minikube docker-env
```

> è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨åˆ‡æ¢ç»ˆç«¯ï¼Œæ‚¨éœ€è¦é‡æ–°è¿æ¥åˆ° minikube å†…éƒ¨çš„ Docker å®ˆæŠ¤è¿›ç¨‹ã€‚ æ¯æ¬¡ä½¿ç”¨ä¸åŒçš„ç»ˆç«¯æ—¶ï¼Œéƒ½åº”éµå¾ªç›¸åŒçš„è¯´æ˜ã€‚

å¹¶ä»é¡¹ç›®çš„æ ¹ç›®å½•æ„å»ºå®¹å™¨é•œåƒï¼š

```
docker build -t spring-k8s-hpa .
```

æ‚¨å¯ä»¥éªŒè¯æ˜ åƒæ˜¯å¦å·²æ„å»ºå¹¶å‡†å¤‡å¥½è¿è¡Œï¼š

```
docker images | grep spring
```

å®Œç¾ï¼
é›†ç¾¤å‡†å¤‡å¥½äº†ï¼Œä½ æ‰“åŒ…äº†ä½ çš„åº”ç”¨ç¨‹åºï¼Œä¹Ÿè®¸ä½ ç°åœ¨å·²ç»å‡†å¤‡å¥½éƒ¨ç½²äº†ï¼Ÿ
æ˜¯çš„ï¼Œæ‚¨ç»ˆäºå¯ä»¥è¦æ±‚ Kubernetes éƒ¨ç½²åº”ç”¨ç¨‹åºäº†ã€‚

## å°†æ‚¨çš„åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetes

æ‚¨çš„åº”ç”¨ç¨‹åºåŒ…å«ä¸‰ä¸ªç»„ä»¶ï¼š
 * å‘ˆç°å‰ç«¯çš„ Spring Boot åº”ç”¨ç¨‹åº
 * ActiveMQ ä½œä¸ºæ¶ˆæ¯ä»£ç†
 * å¤„ç†äº‹åŠ¡çš„ Spring Boot åç«¯
æ‚¨åº”è¯¥åˆ†åˆ«éƒ¨ç½²è¿™ä¸‰ä¸ªç»„ä»¶ã€‚
å¯¹äºå®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªï¼Œæ‚¨åº”è¯¥åˆ›å»ºï¼š
 * æè¿°éƒ¨ç½²ä»€ä¹ˆå®¹å™¨åŠå…¶é…ç½®çš„éƒ¨ç½²å¯¹è±¡
 * ä¸€ä¸ªæœåŠ¡å¯¹è±¡ï¼Œå……å½“éƒ¨ç½²åˆ›å»ºçš„åº”ç”¨ç¨‹åºçš„æ‰€æœ‰å®ä¾‹çš„è´Ÿè½½å‡è¡¡å™¨
éƒ¨ç½²ä¸­åº”ç”¨ç¨‹åºçš„æ¯ä¸ªå®ä¾‹éƒ½ç§°ä¸º Podã€‚

{% asset_img 11.gif ç¤ºæ„å›¾ width="400" %}

## éƒ¨ç½² ActiveMQ

è®©æˆ‘ä»¬ä» ActiveMQ å¼€å§‹ã€‚
æ‚¨åº”è¯¥åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ activemq-deployment.yaml æ–‡ä»¶ï¼š

```yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: queue
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: queue
    spec:
      containers:
      - name: web
        image: webcenter/activemq:5.14.3
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 61616
        resources:
          limits:
            memory: 512Mi
```

å†…å®¹çœ‹ç€æŒºå¤šçš„ï¼Œä½†è¯»èµ·æ¥è¿˜å¾ˆç®€å•ï¼š
 * æ‚¨ä»åä¸º webcenter/activemq çš„å®˜æ–¹æ³¨å†Œè¡¨ä¸­è¯·æ±‚äº†ä¸€ä¸ª activemq å®¹å™¨
 * å®¹å™¨åœ¨ç«¯å£ 61616 ä¸Šå…¬å¼€æ¶ˆæ¯ä»£ç†
 * ä¸ºå®¹å™¨åˆ†é…äº† 512MB å†…å­˜
 * ä½ è¦æ±‚ä¸€ä¸ªå‰¯æœ¬â€”â€”ä½ çš„åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå®ä¾‹
åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ activemq-service.yaml æ–‡ä»¶ï¼š

```
apiVersion: v1
kind: Service
metadata:
  name: queue
spec:
  ports:
  - port: 61616 
    targetPort: 61616
  selector:
    app: queue
```

å¹¸è¿çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡æ¿æ›´çŸ­ï¼
yaml å†…å®¹å¦‚ä¸‹ï¼š
 * æ‚¨åˆ›å»ºäº†ä¸€ä¸ªå…¬å¼€ç«¯å£ 61616 çš„è´Ÿè½½å‡è¡¡å™¨
 * ä¼ å…¥æµé‡è¢«åˆ†å‘åˆ°æ‰€æœ‰å…·æœ‰ app: queue ç±»å‹æ ‡ç­¾çš„ Podï¼ˆå‚è§ä¸Šé¢çš„éƒ¨ç½²ï¼‰
 * targetPort æ˜¯ Pod æš´éœ²çš„ç«¯å£
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºèµ„æºï¼š

```
kubectl create -f activemq-deployment.yaml
kubectl create -f activemq-service.yaml
```

æ‚¨å¯ä»¥éªŒè¯æ•°æ®åº“çš„ä¸€ä¸ªå®ä¾‹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š

```
kubectl get pods -l=app=queue
```

## éƒ¨ç½²å‰ç«¯

åˆ›å»ºåŒ…å«ä»¥ä¸‹å†…å®¹çš„ fe-deployment.yaml æ–‡ä»¶ï¼š

```yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: spring-boot-hpa
        imagePullPolicy: IfNotPresent
        env:
        - name: ACTIVEMQ_BROKER_URL
          value: "tcp://queue:61616"
        - name: STORE_ENABLED
          value: "true"
        - name: WORKER_ENABLED
          value: "false"
        ports:
        - containerPort: 8080
        livenessProbe:
          initialDelaySeconds: 5
          periodSeconds: 5
          httpGet:
            path: /health
            port: 8080
        resources:
          limits:
            memory: 512Mi
```

éƒ¨ç½²çœ‹èµ·æ¥å¾ˆåƒå‰ä¸€ä¸ªã€‚
ä¸è¿‡ï¼Œæœ‰ä¸€äº›æ–°é¢†åŸŸï¼š
 * æœ‰ä¸€ä¸ªéƒ¨åˆ†å¯ä»¥æ³¨å…¥ç¯å¢ƒå˜é‡
 * æœ‰ä¸€ä¸ª liveness probe ä¼šå‘Šè¯‰ä½ åº”ç”¨ç¨‹åºä½•æ—¶å‡†å¤‡å¥½æ¥å—æµé‡
åˆ›å»ºä¸€ä¸ª fe-service.yaml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: frontend
spec:
  ports:
  - nodePort: 32000
    port: 80
    targetPort: 8080
  selector:
    app: frontend
  type: NodePort

```

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºèµ„æºï¼š

```
kubectl create -f fe-deployment.yaml
kubectl create -f fe-service.yaml
```

æ‚¨å¯ä»¥éªŒè¯å‰ç«¯åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå®ä¾‹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š

```
kubectl get pods -l=app=frontend
```

## éƒ¨ç½²åç«¯

åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ backend-deployment.yaml æ–‡ä»¶ï¼š

```yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: backend
      annotations:
        prometheus.io/scrape: 'true'
    spec:
      containers:
      - name: backend
        image: spring-boot-hpa
        imagePullPolicy: IfNotPresent
        env:
        - name: ACTIVEMQ_BROKER_URL
          value: "tcp://queue:61616"
        - name: STORE_ENABLED
          value: "false"
        - name: WORKER_ENABLED
          value: "true"
        ports:
        - containerPort: 8080
        livenessProbe:
          initialDelaySeconds: 5
          periodSeconds: 5
          httpGet:
            path: /health
            port: 8080
        resources:
          limits:
            memory: 512Mi
```

åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ backend-service.yaml æ–‡ä»¶ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: backend
  spec:
    ports:
    - nodePort: 31000
      port: 80
      targetPort: 8080
    selector:
      app: backend
    type: NodePort
```
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºèµ„æºï¼š

```
kubectl create -f backend-deployment.yaml
kubectl create -f backend-service.yaml
```

æ‚¨å¯ä»¥éªŒè¯åç«¯çš„ä¸€ä¸ªå®ä¾‹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š

```
kubectl get pods -l=app=backend
```
éƒ¨ç½²å®Œæˆã€‚

**ä¸è¿‡ï¼Œå®ƒçœŸçš„å·²ç»å¼€å§‹å·¥ä½œäº†å—ï¼Ÿ**

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨æµè§ˆå™¨ä¸­è®¿é—®è¯¥åº”ç”¨ç¨‹åºï¼š

```
minikube service backend
minikube service frontend
```

å¦‚æœæœ‰æ•ˆï¼Œæ‚¨åº”è¯¥å°è¯•è´­ä¹°ä¸€äº›ç‰©å“ï¼
workeræ˜¯å¦åœ¨å¤„ç†äº‹åŠ¡ï¼Ÿ
æ˜¯çš„ï¼Œå¦‚æœæœ‰è¶³å¤Ÿçš„æ—¶é—´ï¼Œworker å°†å¤„ç†æ‰€æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯ã€‚
Congratulations!
æ‚¨åˆšåˆšå°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetesï¼

## æ‰‹åŠ¨æ‰©å±•ä»¥æ»¡è¶³ä¸æ–­å¢é•¿çš„éœ€æ±‚

å•ä¸ªwokerå¯èƒ½æ— æ³•å¤„ç†å¤§é‡æ¶ˆæ¯ã€‚ äº‹å®ä¸Šï¼Œå®ƒä¸€æ¬¡åªèƒ½å¤„ç†ä¸€æ¡æ¶ˆæ¯ã€‚
å¦‚æœæ‚¨å†³å®šè´­ä¹°æ•°åƒä»¶å•†å“ï¼Œåˆ™éœ€è¦æ•°å°æ—¶æ‰èƒ½æ¸…é™¤é˜Ÿåˆ—ã€‚
æ­¤æ—¶ï¼Œæ‚¨æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š
 * æ‚¨å¯ä»¥æ‰‹åŠ¨æ”¾å¤§å’Œç¼©å°
 * æ‚¨å¯ä»¥åˆ›å»ºè‡ªåŠ¨ç¼©æ”¾è§„åˆ™ä»¥è‡ªåŠ¨æ”¾å¤§æˆ–ç¼©å°
è®©æˆ‘ä»¬å…ˆä»åŸºç¡€å¼€å§‹ã€‚
æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å°†åç«¯æ‰©å±•åˆ°ä¸‰ä¸ªå®ä¾‹ï¼š

```
kubectl scale --replicas=5 deployment/backend
```

æ‚¨å¯ä»¥éªŒè¯ Kubernetes æ˜¯å¦åˆ›å»ºäº†å¦å¤–äº”ä¸ªå®ä¾‹ï¼š

```
kubectl get pods
```

è¯¥åº”ç”¨ç¨‹åºå¯ä»¥å¤„ç†äº”å€ä»¥ä¸Šçš„æ¶ˆæ¯ã€‚
ä¸€æ—¦workeræ’ç©ºé˜Ÿåˆ—ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç¼©å‡ï¼š

```
kubectl scale --replicas=1 deployment/backend
```

å¦‚æœæ‚¨çŸ¥é“ä»€ä¹ˆæ—¶å€™è®¿é—®æ‚¨çš„æœåŠ¡çš„æµé‡æœ€å¤šï¼Œé€šè¿‡æ‰‹åŠ¨æ–¹å¼å‘ä¸Šå’Œå‘ä¸‹æ‰©å±•ä¼šæ˜¯ä¸€ç§éå¸¸æ£’çš„ä½“éªŒã€‚
å¦‚æœæ‚¨ä¸è¿™æ ·åšï¼Œè®¾ç½®è‡ªåŠ¨ç¼©æ”¾å™¨å…è®¸åº”ç”¨ç¨‹åºè‡ªåŠ¨ç¼©æ”¾è€Œæ— éœ€äººå·¥å¹²é¢„ã€‚
æ‚¨åªéœ€è¦å®šä¹‰ä¸€äº›è§„åˆ™ã€‚

### å…¬å¼€åº”ç”¨ç¨‹åºæŒ‡æ ‡

Kubernetes å¦‚ä½•çŸ¥é“ä½•æ—¶æ‰©å±•æ‚¨çš„åº”ç”¨ç¨‹åºï¼Ÿ
å¾ˆç®€å•ï¼Œä½ å¿…é¡»å‘Šè¯‰å®ƒã€‚
è‡ªåŠ¨ç¼©æ”¾å™¨é€šè¿‡ç›‘æ§æŒ‡æ ‡æ¥å·¥ä½œã€‚ åªæœ‰è¿™æ ·å®ƒæ‰èƒ½å¢åŠ æˆ–å‡å°‘æ‚¨çš„åº”ç”¨ç¨‹åºçš„å®ä¾‹ã€‚
å› æ­¤ï¼Œæ‚¨å¯ä»¥å°†é˜Ÿåˆ—çš„é•¿åº¦ä½œä¸ºæŒ‡æ ‡å…¬å¼€ï¼Œå¹¶è¦æ±‚è‡ªåŠ¨ç¼©æ”¾å™¨æŸ¥çœ‹è¯¥å€¼ã€‚ é˜Ÿåˆ—ä¸­çš„å¾…å¤„ç†æ¶ˆæ¯è¶Šå¤šï¼ŒKubernetes å°†åˆ›å»ºçš„åº”ç”¨ç¨‹åºå®ä¾‹å°±è¶Šå¤šã€‚

**é‚£ä¹ˆå¦‚ä½•å…¬å¼€è¿™äº›æŒ‡æ ‡å‘¢ï¼Ÿ**

åº”ç”¨ç¨‹åºæœ‰ä¸€ä¸ª /metrics ç«¯ç‚¹æ¥å…¬å¼€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°ã€‚ å¦‚æœæ‚¨å°è¯•è®¿é—®è¯¥é¡µé¢ï¼Œæ‚¨ä¼šæ³¨æ„åˆ°ä»¥ä¸‹å†…å®¹ï¼š

```
# HELP messages Number of messages in the queue
# TYPE messages gauge
messages 0
```

åº”ç”¨ç¨‹åºä¸ä¼šå°†æŒ‡æ ‡å…¬å¼€ä¸º JSON æ ¼å¼ã€‚ æ ¼å¼æ˜¯çº¯æ–‡æœ¬ï¼Œæ˜¯å…¬å¼€ [Prometheus æŒ‡æ ‡](https://prometheus.io/docs/concepts/metric_types/)çš„æ ‡å‡†ã€‚ ä¸è¦æ‹…å¿ƒè®°ä½æ ¼å¼ã€‚ å¤§å¤šæ•°æ—¶å€™ï¼Œæ‚¨å°†ä½¿ç”¨ Prometheus å®¢æˆ·ç«¯åº“ä¹‹ä¸€ã€‚

### åœ¨ Kubernetes ä¸­ä½¿ç”¨åº”ç”¨ç¨‹åºæŒ‡æ ‡

æ‚¨å‡ ä¹å·²å‡†å¤‡å¥½è¿›è¡Œè‡ªåŠ¨ç¼©æ”¾â€”â€”ä½†æ‚¨åº”è¯¥å…ˆå®‰è£…æŒ‡æ ‡æœåŠ¡å™¨ã€‚ äº‹å®ä¸Šï¼ŒKubernetes é»˜è®¤ä¸ä¼šä»æ‚¨çš„åº”ç”¨ç¨‹åºä¸­æå–æŒ‡æ ‡ã€‚ å¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨åº”è¯¥å¯ç”¨è‡ªå®šä¹‰æŒ‡æ ‡ APIã€‚
è¦å®‰è£…è‡ªå®šä¹‰æŒ‡æ ‡ APIï¼Œæ‚¨è¿˜éœ€è¦ Prometheus â€” ä¸€ä¸ªæ—¶é—´åºåˆ—æ•°æ®åº“ã€‚ å®‰è£… Custom Metrics API æ‰€éœ€çš„æ‰€æœ‰æ–‡ä»¶éƒ½æ–¹ä¾¿åœ°æ‰“åŒ…åœ¨ learnk8s/spring-boot-k8s-hpa ä¸­ã€‚
æ‚¨åº”è¯¥ä¸‹è½½è¯¥å­˜å‚¨åº“çš„å†…å®¹å¹¶å°†å½“å‰ç›®å½•æ›´æ”¹ä¸ºè¯¥é¡¹ç›®çš„ç›‘è§†æ–‡ä»¶å¤¹ä¸­ã€‚

```
cd spring-boot-k8s-hpa/monitoring
```

æ‚¨å¯ä»¥ä»é‚£é‡Œåˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ APIï¼š

```
kubectl create -f ./metrics-server
kubectl create -f ./namespaces.yaml
kubectl create -f ./prometheus
kubectl create -f ./custom-metrics-api
```

æ‚¨åº”è¯¥ç­‰åˆ°ä»¥ä¸‹å‘½ä»¤è¿”å›è‡ªå®šä¹‰æŒ‡æ ‡åˆ—è¡¨ï¼š

```
kubectl get --raw "/apis/custom.metrics.k8s.io/v1beta1" | jq .
```

ä»»åŠ¡å®Œæˆï¼

### æ‚¨å·²å‡†å¤‡å¥½ä½¿ç”¨æŒ‡æ ‡ã€‚

äº‹å®ä¸Šï¼Œæ‚¨åº”è¯¥å·²ç»æ‰¾åˆ°äº†é˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°é‡çš„è‡ªå®šä¹‰æŒ‡æ ‡ï¼š

```
kubectl get --raw "/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/messages" | jq .
```

æ­å–œï¼Œæ‚¨æœ‰ä¸€ä¸ªå…¬å¼€æŒ‡æ ‡çš„åº”ç”¨ç¨‹åºå’Œä¸€ä¸ªä½¿ç”¨å®ƒä»¬çš„æŒ‡æ ‡æœåŠ¡å™¨ã€‚
æ‚¨ç»ˆäºå¯ä»¥å¯ç”¨è‡ªåŠ¨ç¼©æ”¾å™¨äº†ï¼

### Kubernetes ä¸­çš„è‡ªåŠ¨æ‰©å±•éƒ¨ç½²

Kubernetes æœ‰ä¸€ä¸ªåä¸º Horizontal Pod Autoscaler çš„å¯¹è±¡ï¼Œç”¨äºç›‘æ§éƒ¨ç½²å¹¶å‘ä¸Šå’Œå‘ä¸‹æ‰©å±• Pod çš„æ•°é‡ã€‚
æ‚¨å°†éœ€è¦å…¶ä¸­ä¹‹ä¸€æ¥è‡ªåŠ¨æ‰©å±•æ‚¨çš„å®ä¾‹ã€‚
æ‚¨åº”è¯¥åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ hpa.yaml æ–‡ä»¶ï¼š

```yaml
apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  name: spring-boot-hpa
spec:
  scaleTargetRef:
    apiVersion: extensions/v1beta1
    kind: Deployment
    name: backend 
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Pods
    pods:
      metricName: messages
      targetAverageValue: 10
```

è¯¥æ–‡ä»¶å¾ˆç¥ç§˜ï¼Œæ‰€ä»¥è®©æˆ‘ä¸ºæ‚¨ç¿»è¯‘ä¸€ä¸‹ï¼š
Kubernetes ç›‘è§† scaleTargetRef ä¸­æŒ‡å®šçš„éƒ¨ç½²ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯workerã€‚
æ‚¨æ­£åœ¨ä½¿ç”¨æ¶ˆæ¯æŒ‡æ ‡æ¥æ‰©å±•æ‚¨çš„ Podã€‚ å½“é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¶…è¿‡ 10 æ¡æ—¶ï¼ŒKubernetes å°†è§¦å‘è‡ªåŠ¨ç¼©æ”¾ã€‚
è‡³å°‘ï¼Œéƒ¨ç½²åº”è¯¥æœ‰ä¸¤ä¸ª Podã€‚ åä¸ª Pod æ˜¯ä¸Šé™ã€‚
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºèµ„æºï¼š

```
kubectl create -f hpa.yaml
```

æäº¤è‡ªåŠ¨ç¼©æ”¾å™¨åï¼Œæ‚¨åº”è¯¥æ³¨æ„åˆ°åç«¯çš„å‰¯æœ¬æ•°ä¸ºä¸¤ä¸ªã€‚ è¿™æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºæ‚¨è¦æ±‚è‡ªåŠ¨ç¼©æ”¾å™¨å§‹ç»ˆè‡³å°‘è¿è¡Œä¸¤ä¸ªå‰¯æœ¬ã€‚
æ‚¨å¯ä»¥æ£€æŸ¥è§¦å‘è‡ªåŠ¨ç¼©æ”¾å™¨çš„æ¡ä»¶ä»¥åŠç”±æ­¤ç”Ÿæˆçš„äº‹ä»¶ï¼š

```
kubectl describe hpa
```

è‡ªåŠ¨æ‰©ç¼©å™¨è¡¨æ˜å®ƒèƒ½å¤Ÿå°† Pod æ‰©å±•åˆ° 2 ä¸ªï¼Œå¹¶å‡†å¤‡å¥½ç›‘æ§éƒ¨ç½²ã€‚

**ä»¤äººå…´å¥‹çš„ä¸œè¥¿ï¼Œä½†å®ƒæœ‰æ•ˆå—ï¼Ÿ**

### è´Ÿè½½æµ‹è¯•

åªæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥çŸ¥é“å®ƒæ˜¯å¦æœ‰æ•ˆï¼šåœ¨é˜Ÿåˆ—ä¸­åˆ›å»ºå¤§é‡æ¶ˆæ¯ã€‚
è½¬åˆ°å‰ç«¯åº”ç”¨ç¨‹åºå¹¶å¼€å§‹æ·»åŠ å¤§é‡æ¶ˆæ¯ã€‚ æ·»åŠ æ¶ˆæ¯æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ç›‘æ§ Horizontal Pod Autoscaler çš„çŠ¶æ€ï¼š

```
kubectl describe hpa
```

Pod çš„æ•°é‡ä» 2 ä¸ªå¢åŠ åˆ° 4 ä¸ªï¼Œç„¶åæ˜¯ 8 ä¸ªï¼Œæœ€åæ˜¯ 10 ä¸ªã€‚
**è¯¥åº”ç”¨ç¨‹åºéšæ¶ˆæ¯æ•°é‡è€Œæ‰©å±•ï¼ æ¬¢å‘¼å§ï¼**
æ‚¨åˆšåˆšéƒ¨ç½²äº†ä¸€ä¸ªå®Œå…¨å¯æ‰©å±•çš„åº”ç”¨ç¨‹åºï¼Œè¯¥åº”ç”¨ç¨‹åºå¯æ ¹æ®é˜Ÿåˆ—ä¸­å¾…å¤„ç†æ¶ˆæ¯çš„æ•°é‡è¿›è¡Œæ‰©å±•ã€‚
é™„å¸¦è¯´æ˜ä¸€ä¸‹ï¼Œç¼©æ”¾ç®—æ³•å¦‚ä¸‹ï¼š

```
MAX(CURRENT_REPLICAS_LENGTH * 2, 4)
```

æ­¤å¤–ï¼Œæ¯ä¸€æ¬¡æ”¾å¤§éƒ½ä¼šæ¯åˆ†é’Ÿé‡æ–°è¯„ä¼°ä¸€æ¬¡ï¼Œè€Œæ¯ä¸¤åˆ†é’Ÿç¼©å°ä¸€æ¬¡ã€‚
ä»¥ä¸Šéƒ½æ˜¯å¯ä»¥è°ƒæ•´çš„è®¾ç½®ã€‚
ä¸è¿‡ï¼Œä½ è¿˜æ²¡æœ‰å®Œæˆã€‚

### æœ‰ä»€ä¹ˆæ¯”è‡ªåŠ¨ç¼©æ”¾å®ä¾‹æ›´å¥½çš„å‘¢ï¼Ÿ è‡ªåŠ¨ç¼©æ”¾é›†ç¾¤ã€‚

è·¨èŠ‚ç‚¹æ‰©å±• Pod çš„æ•ˆæœéå¸¸å¥½ã€‚ ä½†æ˜¯ï¼Œå¦‚æœé›†ç¾¤ä¸­æ²¡æœ‰è¶³å¤Ÿçš„å®¹é‡æ¥æ‰©å±• Pod æ€ä¹ˆåŠï¼Ÿ
å¦‚æœè¾¾åˆ°å³°å€¼å®¹é‡ï¼ŒKubernetes å°†ä½¿ Pod å¤„äºæŒ‚èµ·çŠ¶æ€å¹¶ç­‰å¾…æ›´å¤šèµ„æºå¯ç”¨ã€‚
å¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼äº Horizontal Pod Autoscaler ä½†ç”¨äºèŠ‚ç‚¹çš„è‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œé‚£å°±å¤ªå¥½äº†ã€‚

æ‚¨å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªé›†ç¾¤è‡ªåŠ¨æ‰©ç¼©å™¨ï¼Œåœ¨æ‚¨éœ€è¦æ›´å¤šèµ„æºæ—¶å‘ Kubernetes é›†ç¾¤æ·»åŠ æ›´å¤šèŠ‚ç‚¹ã€‚

{% asset_img 12.gif ç¤ºæ„å›¾ width="400" %}

é›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨æœ‰ä¸åŒçš„å½¢çŠ¶å’Œå¤§å°ã€‚ å®ƒä¹Ÿæ˜¯ç‰¹å®šäºäº‘æä¾›å•†çš„ã€‚

### å›é¡¾ä¸€ä¸‹
å¤§è§„æ¨¡è®¾è®¡åº”ç”¨ç¨‹åºéœ€è¦ä»”ç»†è§„åˆ’å’Œæµ‹è¯•ã€‚
åŸºäºé˜Ÿåˆ—çš„æ¶æ„æ˜¯ä¸€ç§å‡ºè‰²çš„è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥è§£è€¦å¾®æœåŠ¡å¹¶ç¡®ä¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹æ‰©å±•å’Œéƒ¨ç½²ã€‚
è™½ç„¶æ‚¨å¯ä»¥æ¨å‡ºéƒ¨ç½²è„šæœ¬ï¼Œä½†åˆ©ç”¨ Kubernetes ç­‰å®¹å™¨ç¼–æ’å™¨æ¥è‡ªåŠ¨éƒ¨ç½²å’Œæ‰©å±•åº”ç”¨ç¨‹åºä¼šæ›´å®¹æ˜“ã€‚