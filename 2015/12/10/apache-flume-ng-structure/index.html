<!DOCTYPE html><html lang=""><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content=""/><title>apache-flume-ng-structure | Tensor Cell</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">apache-flume-ng-structure</h1><a id="logo" href="/">Tensor Cell</a><p class="description">还要再走500里</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">apache-flume-ng-structure</h1><div class="post-meta">2015-12-10 | <span class="categories">分类于<a href="/categories/数据挖掘/"> 数据挖掘</a></span></div><span data-disqus-identifier="2015/12/10/apache-flume-ng-structure/" class="disqus-comment-count"></span><div class="post-content"><!--  -->
<!--  -->
<!--  _ __    __     __      ____    ___     ___   _____   __  __    ___     -->
<!-- /\`'__\/'__`\ /'__`\   /',__\  / __`\ /' _ `\/\ '__`\/\ \/\ \ /' _ `\   -->
<!-- \ \ \//\  __//\ \L\.\_/\__, `\/\ \L\ \/\ \/\ \ \ \L\ \ \ \_\ \/\ \/\ \  -->
<!--  \ \_\\ \____\ \__/.\_\/\____/\ \____/\ \_\ \_\ \ ,__/\ \____/\ \_\ \_\ -->
<!--   \/_/ \/____/\/__/\/_/\/___/  \/___/  \/_/\/_/\ \ \/  \/___/  \/_/\/_/ -->
<!--                                                 \ \_\                   -->
<!--                                                  \/_/                   -->
<!--  -->
<h2 id="Apache-flume_NG__u914D_u7F6E"><a href="#Apache-flume_NG__u914D_u7F6E" class="headerlink" title="Apache-flume NG 配置"></a>Apache-flume NG 配置</h2><h3 id="u7B80_u4ECB"><a href="#u7B80_u4ECB" class="headerlink" title="简介"></a>简介</h3><p>  Flume NG是一个分布式、可靠、可用的系统，它能够将不同数据源的海量日志数据进行高效收集、聚合、移动，最后存储到一个中心化数据存储系统中。</p>
<p>  由原来的Flume OG到现在的Flume NG，进行了架构重构，并且现在NG版本完全不兼容原来的OG版本。</p>
<p>  经过架构重构后，Flume NG更像是一个轻量的小工具，非常简单，容易适应各种方式日志收集，并支持failover和负载均衡。</p>
<h3 id="u67B6_u6784_u8BBE_u8BA1_u8981_u70B9"><a href="#u67B6_u6784_u8BBE_u8BA1_u8981_u70B9" class="headerlink" title="架构设计要点"></a>架构设计要点</h3><h4 id="u6838_u5FC3_u6982_u5FF5"><a href="#u6838_u5FC3_u6982_u5FF5" class="headerlink" title="核心概念"></a>核心概念</h4><ul>
<li>Event：一个数据单元，带有一个可选的消息头</li>
<li>Flow：Event从源点到达目的点的迁移的抽象</li>
<li>Client：操作位于源点处的Event，将其发送到Flume Agent</li>
<li>Agent：一个独立的Flume进程，包含组件Source、Channel、Sink</li>
<li>Source：用来消费传递到该组件的Event</li>
<li>Channel：中转Event的一个临时存储，保存有Source组件传递过来的Event</li>
<li>Sink：从Channel中读取并移除Event，将Event传递到Flow Pipeline中的下一个Agent（如果有的话）</li>
</ul>
<h4 id="u67B6_u6784_u56FE"><a href="#u67B6_u6784_u56FE" class="headerlink" title="架构图"></a>架构图</h4><pre><code><img src="/images/flume-ng/flume-ng-architecture.png" title="flume-ng总体结构图">
</code></pre><h4 id="u57FA_u672C_u6D41_u7A0B"><a href="#u57FA_u672C_u6D41_u7A0B" class="headerlink" title="基本流程"></a>基本流程</h4><p>外部系统产生日志，直接通过Flume的Agent的Source组件将事件（如日志行）发送到中间临时的channel组件，最后传递给Sink组件，HDFS Sink组件可以直接把数据存储到HDFS集群上。</p>
<h4 id="u5355Agent"><a href="#u5355Agent" class="headerlink" title="单Agent"></a>单Agent</h4><p>  一个最基本Flow的配置，格式如下：</p>
  <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list the sources, sinks and channels for the agent</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources = <span class="variable">&lt;Source1&gt;</span> <span class="variable">&lt;Source2&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sinks = <span class="variable">&lt;Sink1&gt;</span> <span class="variable">&lt;Sink2&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.channels = <span class="variable">&lt;Channel1&gt;</span> <span class="variable">&lt;Channel2&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set channel for source</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.channels = <span class="variable">&lt;Channel1&gt;</span> <span class="variable">&lt;Channel2&gt;</span> ...</span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source2&gt;</span>.channels = <span class="variable">&lt;Channel1&gt;</span> <span class="variable">&lt;Channel2&gt;</span> ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># set channel for sink</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sinks.<span class="variable">&lt;Sink1&gt;</span>.channel = <span class="variable">&lt;Channel1&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sinks.<span class="variable">&lt;Sink2&gt;</span>.channel = <span class="variable">&lt;Channel2&gt;</span></span><br></pre></td></tr></table></figure>
<p>  尖括号里面的，我们可以根据实际需求或业务来修改名称。</p>
<p>  下面详细说明：</p>
<ul>
<li><agent> 表示配置一个Agent的名称，一个Agent肯定有一个名称。</agent></li>
<li><source1>和<source2>是Agent的Source组件的名称，消费传递过来的Event。</source2></source1></li>
<li><channel1>和<channel2>是Agent的Channel组件的名称。</channel2></channel1></li>
<li><p><sink1>与<sink2>是Agent的Sink组件的名称，从Channel中消费（移除）Event。</sink2></sink1></p>
<p>上面配置内容中</p>
</li>
<li><p>第一组中配置Source、Sink、Channel，它们的值可以有1个或者多个；</p>
</li>
<li>第二组中配置Source将把数据存储（Put）到哪一个Channel中，可以存储到1个或多个Channel中，<br>同一个Source将数据存储到多个Channel中，实际上是Replication；</li>
<li>第三组中配置Sink从哪一个Channel中取（Task）数据，一个Sink只能从一个Channel中取数据。</li>
</ul>
<h4 id="u591A_u4E2AAgent_u987A_u5E8F_u8FDE_u63A5"><a href="#u591A_u4E2AAgent_u987A_u5E8F_u8FDE_u63A5" class="headerlink" title="多个Agent顺序连接"></a>多个Agent顺序连接</h4>  <img src="/images/flume-ng/flume-multiseq-agents.png" title="flume-ng 多个Agent顺序连接">
<p>  可以将多个Agent顺序连接起来，将最初的数据源经过收集，存储到最终的存储系统中。这是最简单的情况，一般情况下，应该控制这种顺序连接的Agent的数量，因为数据流经的路径变长了，如果不考虑failover的话，出现故障将影响整个Flow上的Agent收集服务。</p>
<h4 id="u591A_u4E2AAgent_u7684_u6570_u636E_u6C47_u805A_u5230_u540C_u4E00_u4E2AAgent"><a href="#u591A_u4E2AAgent_u7684_u6570_u636E_u6C47_u805A_u5230_u540C_u4E00_u4E2AAgent" class="headerlink" title="多个Agent的数据汇聚到同一个Agent"></a>多个Agent的数据汇聚到同一个Agent</h4>  <img src="/images/flume-ng/flume-join-agent.png" title="flume-ng 多个Agent的数据汇聚到同一个Agent">
<p>  这种情况应用的场景比较多，比如要收集Web网站的用户行为日志，Web网站为了可用性使用的负载均衡的集群模式，每个节点都产生用户行为日志，可以为每个节点都配置一个Agent来单独收集日志数据，然后多个Agent将数据最终汇聚到一个用来存储数据存储系统，如HDFS上。</p>
<h4 id="u591A_u8DEF_uFF08Multiplexing_uFF09Agent"><a href="#u591A_u8DEF_uFF08Multiplexing_uFF09Agent" class="headerlink" title="多路（Multiplexing）Agent"></a>多路（Multiplexing）Agent</h4>  <img src="/images/flume-ng/flume-multiplexing-agent.png" title="flume-ng 多路（Multiplexing）Agent">
<p>  这种模式，有两种方式</p>
<ul>
<li><p>一种是用来复制（Replication）</p>
<ul>
<li><p>Replication方式，可以将最前端的数据源复制多份，分别传递到多个channel中，每个channel接收到的数据都是相同的，配置格式</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># List the sources, sinks and channels for the agent</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources = <span class="variable">&lt;Source1&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sinks = <span class="variable">&lt;Sink1&gt;</span> <span class="variable">&lt;Sink2&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.channels = <span class="variable">&lt;Channel1&gt;</span> <span class="variable">&lt;Channel2&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set list of channels for source (separated by space)</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.channels = <span class="variable">&lt;Channel1&gt;</span> <span class="variable">&lt;Channel2&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set channel for sinks</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sinks.<span class="variable">&lt;Sink1&gt;</span>.channel = <span class="variable">&lt;Channel1&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sinks.<span class="variable">&lt;Sink2&gt;</span>.channel = <span class="variable">&lt;Channel2&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.selector.type = replicating</span><br></pre></td></tr></table></figure>
<p>使用的Replication方式，Source1会将数据分别存储到Channel1和Channel2，这两个channel里面存储的数据是相同的，然后数据被传递到Sink1和Sink2。</p>
</li>
</ul>
</li>
<li><p>另一种是用来分流（Multiplexing）</p>
<ul>
<li><p>Multiplexing方式，selector可以根据header的值来确定数据传递到哪一个channel</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mapping for multiplexing selector</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.selector.type = multiplexing</span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.selector.header = <span class="variable">&lt;someHeader&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.selector.mapping.<span class="variable">&lt;Value1&gt;</span> = <span class="variable">&lt;Channel1&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.selector.mapping.<span class="variable">&lt;Value2&gt;</span> = <span class="variable">&lt;Channel1&gt;</span> <span class="variable">&lt;Channel2&gt;</span></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.selector.mapping.<span class="variable">&lt;Value3&gt;</span> = <span class="variable">&lt;Channel2&gt;</span></span><br><span class="line"><span class="comment">#...</span></span><br><span class="line"></span><br><span class="line"><span class="variable">&lt;Agent&gt;</span>.sources.<span class="variable">&lt;Source1&gt;</span>.selector.<span class="keyword">default</span> = <span class="variable">&lt;Channel2&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面selector的type的值为multiplexing，同时配置selector的header信息，还配置了多个selector的mapping的值，即header的值：如果header的值为Value1、Value2，数据从Source1路由到Channel1；如果header的值为Value2、Value3，数据从Source1路由到Channel2。</p>
</li>
</ul>
</li>
</ul>
<h4 id="u5B9E_u73B0load_balance_u529F_u80FD"><a href="#u5B9E_u73B0load_balance_u529F_u80FD" class="headerlink" title="实现load balance功能"></a>实现load balance功能</h4>  <img src="/images/flume-ng/flume-load-balance-agents.png" title="实现load balance功能">
<p>  Load balancing Sink Processor能够实现load balance功能，上图Agent1是一个路由节点，<br>  负责将Channel暂存的Event均衡到对应的多个Sink组件上，而每个Sink组件分别连接到一个独立的Agent上</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a1<span class="class">.sinkgroups</span> = g1</span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.sinks</span> = k1 k2 k3</span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.type</span> = load_balance</span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.backoff</span> = true</span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.selector</span> = round_robin</span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.selector</span><span class="class">.maxTimeOut</span>=<span class="number">10000</span></span><br></pre></td></tr></table></figure>
<h4 id="u5B9E_u73B0failover_u80FD"><a href="#u5B9E_u73B0failover_u80FD" class="headerlink" title="实现failover能"></a>实现failover能</h4><p>  Failover Sink Processor能够实现failover功能，具体流程类似load balance，<br>  但是内部处理机制与load balance完全不同：Failover Sink Processor维护一个优先级Sink组件列表，只要有一个Sink组件可用，<br>  Event就被传递到下一个组件。如果一个Sink能够成功处理Event，则会加入到一个Pool中，否则会被移出Pool并计算失败次数，设置一个惩罚因子</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a1<span class="class">.sinkgroups</span> = g1</span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.sinks</span> = k1 k2 k3</span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.type</span> = failover</span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.priority</span><span class="class">.k1</span> = <span class="number">5</span></span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.priority</span><span class="class">.k2</span> = <span class="number">7</span></span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.priority</span><span class="class">.k3</span> = <span class="number">6</span></span><br><span class="line">a1<span class="class">.sinkgroups</span><span class="class">.g1</span><span class="class">.processor</span><span class="class">.maxpenalty</span> = <span class="number">20000</span></span><br></pre></td></tr></table></figure>
<h3 id="u5B89_u88C5_u914D_u7F6E"><a href="#u5B89_u88C5_u914D_u7F6E" class="headerlink" title="安装配置"></a>安装配置</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载二进制包</span></span><br><span class="line">[mofun_mining<span class="variable">@i</span>-tev02vc1 ~]<span class="variable">$ </span>wget <span class="string">"http://www.gtlib.gatech.edu/pub/apache/flume/1.6.0/apache-flume-1.6.0-bin.tar.gz"</span></span><br><span class="line">[mofun_mining<span class="variable">@i</span>-tev02vc1 ~]<span class="variable">$ </span>tar xvzf apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin.tar.gz</span><br><span class="line">[mofun_mining<span class="variable">@i</span>-tev02vc1 ~]<span class="variable">$ </span>mv apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin /usr/local/</span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">[mofun_mining<span class="variable">@i</span>-qe32ajmq conf]<span class="variable">$ </span>pwd</span><br><span class="line">/usr/local/apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin/conf</span><br><span class="line">[mofun_mining<span class="variable">@i</span>-qe32ajmq conf]<span class="variable">$ </span>sudo cp flume-conf.properties.template flume-conf.properties</span><br></pre></td></tr></table></figure>
<p>采用 Avro Source+Memory Channel+HDFS Sink 方式</p>
<ul>
<li><p>服务器（日志汇总服务器agent）端配置文件</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[mofun_mining@i-tev02vc1 ~]$ <span class="keyword">cd</span> /usr/<span class="keyword">local</span>/apache-flume-1.6.0-bin/<span class="keyword">conf</span>/</span><br><span class="line">[mofun_mining@i-tev02vc1 <span class="keyword">conf</span>]$ <span class="keyword">ls</span></span><br><span class="line">flume-<span class="keyword">conf</span>.properties  flume-<span class="keyword">conf</span>.properties.template  flume-env.ps1.template  flume-env.<span class="keyword">sh</span>  flume-env.<span class="keyword">sh</span>.template  log4j.properties</span><br><span class="line">[mofun_mining@i-tev02vc1 <span class="keyword">conf</span>]$ <span class="keyword">pwd</span></span><br><span class="line">/usr/<span class="keyword">local</span>/apache-flume-1.6.0-bin/<span class="keyword">conf</span></span><br><span class="line">[mofun_mining@i-tev02vc1 <span class="keyword">conf</span>]$ sudo vim flume-<span class="keyword">conf</span>.properties</span><br><span class="line"># example.<span class="keyword">conf</span>: A single-node Flume configuration</span><br><span class="line"></span><br><span class="line"># Name the components <span class="keyword">on</span> this agent</span><br><span class="line">agent1.sources = r1</span><br><span class="line">agent1.sinks = k1</span><br><span class="line">agent1.channels = c1</span><br><span class="line"></span><br><span class="line"># <span class="keyword">Describe</span>/configure the source</span><br><span class="line">agent1.sources.r1.<span class="keyword">type</span> = avro</span><br><span class="line">agent1.sources.r1.bind = 192.168.1.33</span><br><span class="line">agent1.sources.r1.port = 41414</span><br><span class="line">agent1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line"># <span class="keyword">Describe</span> the sink</span><br><span class="line">agent1.sinks.k1.<span class="keyword">type</span> = hdfs</span><br><span class="line">agent1.sinks.k1.channel = c1</span><br><span class="line">agent1.sinks.k1.hdfs.fileType = DataStream</span><br><span class="line">agent1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">agent1.sinks.k1.hdfs.path = /flume/events/%Y-%<span class="keyword">m</span>-%<span class="literal">d</span></span><br><span class="line">#agent1.sinks.k1.hdfs.round = true</span><br><span class="line">#agent1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">#agent1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">agent1.sinks.k1.hdfs.rollCount = 5000</span><br><span class="line">agent1.sinks.k1.hdfs.rollSize = 0</span><br><span class="line">agent1.sinks.k1.hdfs.rollInterval= 0</span><br><span class="line"></span><br><span class="line"># <span class="keyword">Use</span> a channel <span class="keyword">which</span> buffers events <span class="keyword">in</span> <span class="keyword">memory</span></span><br><span class="line">agent1.channels.c1.<span class="keyword">type</span> = <span class="keyword">memory</span></span><br><span class="line">agent1.channels.c1.capacity = 10000</span><br><span class="line">agent1.channels.c1.transactionCapacity = 1000</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端（日志收集agent）</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[reason@i-qunray9x <span class="keyword">conf</span>]$ <span class="keyword">cd</span> /usr/<span class="keyword">local</span>/apache-flume-1.6.0-bin/<span class="keyword">conf</span>/</span><br><span class="line">[reason@i-qunray9x <span class="keyword">conf</span>]$ <span class="keyword">pwd</span></span><br><span class="line">/usr/<span class="keyword">local</span>/apache-flume-1.6.0-bin/<span class="keyword">conf</span></span><br><span class="line">[reason@i-qunray9x <span class="keyword">conf</span>]$ sudo vim flume-<span class="keyword">conf</span>.properties</span><br><span class="line"></span><br><span class="line"># example.<span class="keyword">conf</span>: A single-node Flume configuration</span><br><span class="line"></span><br><span class="line"># Name the components <span class="keyword">on</span> this agent</span><br><span class="line">agent1.sources = r1</span><br><span class="line">agent1.sinks = k1</span><br><span class="line">agent1.channels = c1</span><br><span class="line"></span><br><span class="line"># <span class="keyword">Describe</span>/configure the source</span><br><span class="line">agent1.sources.r1.<span class="keyword">type</span> = exec</span><br><span class="line">agent1.sources.r1.command = tail -<span class="keyword">n</span> 0 -F /home/reason/1.txt</span><br><span class="line">agent1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line"># <span class="keyword">Describe</span> the sink</span><br><span class="line">agent1.sinks.k1.<span class="keyword">type</span> = avro</span><br><span class="line">agent1.sinks.k1.channel = c1</span><br><span class="line">agent1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">agent1.sinks.k1.hdfs.path = /flume/events/%Y-%<span class="keyword">m</span>-%<span class="literal">d</span></span><br><span class="line">agent1.sinks.k1.hostname=192.168.1.33</span><br><span class="line">agent1.sinks.k1.port = 41414</span><br><span class="line"></span><br><span class="line"># <span class="keyword">Use</span> a channel <span class="keyword">which</span> buffers events <span class="keyword">in</span> <span class="keyword">memory</span></span><br><span class="line">agent1.channels.c1.<span class="keyword">type</span> = <span class="keyword">memory</span></span><br><span class="line">agent1.channels.c1.capacity = 5000</span><br><span class="line">agent1.channels.c1.transactionCapacity = 500</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务器</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mofun_mining<span class="annotation">@i</span>-tev02vc1 conf]$</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/apache-flume-1.6.0-bin/</span>bin<span class="regexp">/flume-ng agent -c ./</span>conf<span class="regexp">/ -f /</span>usr<span class="regexp">/local/</span>apache-flume-<span class="number">1.6</span><span class="number">.0</span>-bin<span class="regexp">/conf/</span>flume-conf.properties -n agent1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动客户端</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[reason@i-qunray9x <span class="keyword">conf</span>]$</span><br><span class="line">/usr/<span class="keyword">local</span>/apache-flume-1.6.0-bin/bin/flume-ng agent -c <span class="keyword">conf</span> -f /usr/<span class="keyword">local</span>/apache-flume-1.6.0-bin/<span class="keyword">conf</span>/flume-<span class="keyword">conf</span>.properties -<span class="keyword">n</span> agent1</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mofun_mining@i-r6cuv8iq ~]$ hdfs dfs -ls /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span></span><br><span class="line">Found <span class="number">40</span> items</span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34844</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340281</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340282</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340283</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340284</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340285</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340286</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340287</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340288</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span> /flume/events/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span>/FlumeData<span class="number">.1450172340289</span></span><br><span class="line">-rw-r--r--   <span class="number">2</span> mofun_mining supergroup      <span class="number">34850</span> <span class="number">2015</span>-<span class="number">12</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">39</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>此时，通过nginx实时产生的日志，即可实时插入到hdfs中了。</p>
</li>
</ul>
<h3 id="u53C2_u8003_u6587_u732E"><a href="#u53C2_u8003_u6587_u732E" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><a href="http://shiyanjun.cn/archives/915.html" target="_blank" rel="external">http://shiyanjun.cn/archives/915.html</a></li>
<li><a href="http://my.oschina.net/leejun2005/blog/288136" target="_blank" rel="external">http://my.oschina.net/leejun2005/blog/288136</a></li>
<li><a href="http://tech.meituan.com/mt-log-system-optimization.html" target="_blank" rel="external">http://tech.meituan.com/mt-log-system-optimization.html</a></li>
<li><a href="http://www.ixirong.com/2015/05/18/how-to-install-flume-ng/" target="_blank" rel="external">http://www.ixirong.com/2015/05/18/how-to-install-flume-ng/</a></li>
<li><a href="https://flume.apache.org/FlumeUserGuide.html#setting-up-an-agent" target="_blank" rel="external">https://flume.apache.org/FlumeUserGuide.html#setting-up-an-agent</a></li>
<li><a href="http://m.blog.csdn.net/blog/xueliang1029/24039459" target="_blank" rel="external">http://m.blog.csdn.net/blog/xueliang1029/24039459</a></li>
</ul>
</div><div class="tags"><a href="/tags/Apache/">Apache</a><a href="/tags/Flume-NG/">Flume-NG</a><a href="/tags/HDFS/">HDFS</a></div><div class="post-nav"><a href="/2015/12/14/Genetic-Algorithm/" class="pre"><i class="icon-previous">Genetic Algorithm</i></a><a href="/2015/12/08/apache-kafka-structure/" class="next">apache_kafka_structure<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'reasonpun';
var disqus_identifier = '2015/12/10/apache-flume-ng-structure/';
var disqus_title = 'apache-flume-ng-structure';
var disqus_url = 'http://reasonpun.com/2015/12/10/apache-flume-ng-structure/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//reasonpun.disqus.com/count.js" async="async"></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://reasonpun.com"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/数据挖掘/">数据挖掘</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据挖掘/实时计算/">实时计算</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据挖掘/实时计算/虚拟化/">虚拟化</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据挖掘/实时计算，-源码分析/">实时计算， 源码分析</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统维护/">系统维护</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/系统维护/日志处理/">日志处理</a></li></ul></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/Documentation/" style="font-size: 15px;">Documentation</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/Kernel/" style="font-size: 15px;">Kernel</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/HDFS/" style="font-size: 15px;">HDFS</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Logrorate/" style="font-size: 15px;">Logrorate</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/Source/" style="font-size: 15px;">Source</a> <a href="/tags/Apache/" style="font-size: 15px;">Apache</a> <a href="/tags/Flume-NG/" style="font-size: 15px;">Flume-NG</a> <a href="/tags/Oryx2/" style="font-size: 15px;">Oryx2</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/Spark-Streaming/" style="font-size: 15px;">Spark-Streaming</a> <a href="/tags/Recommendation/" style="font-size: 15px;">Recommendation</a> <a href="/tags/documentation/" style="font-size: 15px;">documentation</a> <a href="/tags/Admin/" style="font-size: 15px;">Admin</a> <a href="/tags/Genetic-Algorithm/" style="font-size: 15px;">Genetic Algorithm</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2015/12/21/Oryx2-Admin-Docs/">Oryx2 Admin Docs</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/21/Oryx2-Overview/">Oryx2 Overview</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/Genetic-Algorithm/">Genetic Algorithm</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/apache-flume-ng-structure/">apache-flume-ng-structure</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/08/apache-kafka-structure/">apache_kafka_structure</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/05/kafa-documentation/">kafka文档简述</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/05/linux-shell-获得以前日期/">linux shell 获得以前日期</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/04/spark-in-docker/">spark-in-docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/04/nginx-logrotate/">nginx-logrotate</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/04/spark-source-1/">spark source (1)</a></li></ul></div><div class="widget"><div class="widget-title">最近评论</div><script type="text/javascript" src="//reasonpun.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://people.csail.mit.edu/matei/" title="Matei Zaharia" target="_blank">Matei Zaharia</a><ul></ul><a href="https://github.com/tensorflow/tensorflow" title="tensorflow" target="_blank">tensorflow</a></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">Tensor Cell.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"></div><!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body></html>