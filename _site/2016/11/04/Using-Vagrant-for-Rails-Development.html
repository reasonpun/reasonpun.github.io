<!DOCTYPE html>
<html lang="zh-CN" >
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  
  <title>使用Vagrant部署Rails项目</title>
  <meta name="description" content="">
  <link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png">
  <link rel="alternate" type="application/rss+xml" title="Tensor Cell" href="/feed.xml">
  
  <link rel="stylesheet" type="text/css" href="/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="/css/pure-min.css">
  <link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css">
  <link rel="stylesheet" type="text/css" href="/css/style.css">
</head>

  <body>
    <div class="body_container">
      <div id="header">
        <div class="site-name">
          <h1 class="hidden">使用Vagrant部署Rails项目</h1>
          <a id="logo" href="/.">Tensor Cell</a>
          <p class="description">还要再走500里</p>
        </div>
        <div id="nav-menu">
          
            <a href="//"><i class="icon-home"> 首页</i></a>
          
            <a href="/archives/"><i class="icon-archive"> 归档</i></a>
          
            <a href="/about/"><i class="icon-about"> 关于</i></a>
          
            <a href="/history/"><i class="icon-history"> 历史</i></a>
          
            <a href="/feed.xml"><i class="icon-rss"> 订阅</i></a>
          
        </div>
      <script type="text/javascript">
      var menus=document.getElementById('nav-menu');
      var ishome = true;
      for (var i=1;i<menus.childElementCount;i++) {
        var path = location.href;
        var current = path.startsWith(menus.children[i].href);
        if (current) {
          menus.children[i].className ='current';
          ishome = false;
          break;
        }
      }
      if (ishome) {
      	menus.children[0].className ='current';
      }
      </script>
      </div>

      <div id="layout" class="pure-g">
        <div class="pure-u-1 pure-u-md-3-4">
          <div class="content_container">
            <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">使用Vagrant部署Rails项目</h1>
    <p class="post-meta"><time datetime="2016-11-04T00:00:00+08:00" itemprop="datePublished">Nov 4, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <!--  -->
<!--  -->
<!--  _ __    __     __      ____    ___     ___   _____   __  __    ___     -->
<!-- /\`'__\/'__`\ /'__`\   /',__\  / __`\ /' _ `\/\ '__`\/\ \/\ \ /' _ `\   -->
<!-- \ \ \//\  __//\ \L\.\_/\__, `\/\ \L\ \/\ \/\ \ \ \L\ \ \ \_\ \/\ \/\ \  -->
<!--  \ \_\\ \____\ \__/.\_\/\____/\ \____/\ \_\ \_\ \ ,__/\ \____/\ \_\ \_\ -->
<!--   \/_/ \/____/\/__/\/_/\/___/  \/___/  \/_/\/_/\ \ \/  \/___/  \/_/\/_/ -->
<!--                                                 \ \_\                   -->
<!--                                                  \/_/                   -->
<!--  -->

<h2 id="简述">简述</h2>

<p>Vagrant 是一个自动化工具，可以在你的电脑的虚拟机里自动搭建一个开发环境。这就意味着你本地开发环境可以完全与生产服务器上保持一致，你的合作小伙伴也可以和你保持高度一致的运行环境。</p>

<p>自个儿的Rails的开发环境也不会随着你开发机的变化而变化。另外，你可以在分分钟内启动一个可能需要在12个月以后重新访问的项目，那时你会感谢自己在项目初期使用了这个工具。</p>

<p>我们会使用<a href="https://www.chef.io/chef/">Chef</a>完成虚拟机开发环境的自动部署。chef会负责为我们的系统配置Ruby和所有依赖的包。非常适合快速开发（It’s pretty RAD）。</p>

<p>BB的够多的了，让我们开始吧！</p>

<h2 id="配置vagrant">配置Vagrant</h2>

<p>首先，开始执行之前确认下本机至少有1G的空闲内存，因为Vagrant会在你的虚拟机中启动一个完整的操作系统，用来执行Rails程序。</p>

<p>第一步，在本机安装Vagrant和VirtualBox。</p>

<ul>
  <li><a href="https://www.vagrantup.com/downloads.html">移步这里下载安装Vagrant</a></li>
  <li><a href="https://www.virtualbox.org/wiki/Downloads">移步这里下载安装VirtualBox</a></li>
</ul>

<p>虚拟机是运行在VirtualBox里的，这些都是后台运行的程序，只能通过SSH进行交互。</p>

<p>其次，我们需要安装Vagrant的两个插件。</p>

<ul>
  <li>vagrant-vbguest 自动安装各种Guest扩展程序</li>
  <li>vagrant-librarian-chef 让我们可以在机器启动的时候自动执行chef</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant plugin install vagrant-vbguest
vagrant plugin install vagrant-librarian-chef-nochef
</code></pre></div></div>

<p>这个可能需要些时间才能执行完毕。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ds git:(dev) vagrant plugin install vagrant-vbguest
Installing the 'vagrant-vbguest' plugin. This can take a few minutes...
Installed the plugin 'vagrant-vbguest (0.13.0)'!
➜  ds git:(dev) vagrant plugin install vagrant-librarian-chef-nochef
Installing the 'vagrant-librarian-chef-nochef' plugin. This can take a few minutes...
Installed the plugin 'vagrant-librarian-chef-nochef (0.2.0)'!
➜  ds git:(dev)

</code></pre></div></div>

<h2 id="创建vagrant配置文件">创建Vagrant配置文件</h2>

<p>首要的，进入需要配置chef的Rails项目目录，并执行如下命令。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ds git:(dev) vagrant init
A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.
➜  ds git:(dev) ✗ touch Cheffile
➜  ds git:(dev) ✗ ls
Cheffile     README.md    app          config.ru    log          tmp
Gemfile      Rakefile     bin          db           public       vendor
Gemfile.lock Vagrantfile  config       lib          test
</code></pre></div></div>

<p>由此会生成Vagrantfile和Cheffile两个文件。</p>

<h2 id="cheffile">Cheffile</h2>

<p>现在，我们可以配置Chef文件了。这个文件和我们的Rails的gem 文件类似，只不过是用于Chef的。这个文件中会定义很多Chef cookbooks用来在稍后的Vagrantfile中指挥Vagrant配置我们的环境的具体内容。</p>

<p>我们仅仅只需要黏贴如下代码到Cheffile中：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
site "http://community.opscode.com/api/v1"

cookbook 'apt'
cookbook 'build-essential'
cookbook 'mysql', '5.5.3'
cookbook 'ruby_build'
cookbook 'nodejs'
cookbook 'rbenv', git: 'https://github.com/aminin/chef-rbenv'
cookbook 'vim'

</code></pre></div></div>

<h2 id="vagrantfile">Vagrantfile</h2>

<p>Vagrantfile 定义了虚拟机中的操作系统和Chef的配置项。</p>

<p>我们会使用Ubuntu 16.04 xenial 64-bit和4G的内存这个版本配置（如果你用的32位的系统，只需要改成xenial32即可）。还需要打开虚拟机的3000端口，这样，我们通过本地浏览器就可以访问虚拟机上的Rails服务了。不过至少到现在为止，我们已经在虚拟机中通过Chef配置好了Ruby2.3.1和MySQL。</p>

<p>Vagrantfile文件的内容如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">"2"</span>

<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># Use Ubuntu 16.04 Xenial Xerus 64-bit as our operating system</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"ubuntu/xenial64"</span>

  <span class="c1"># Configurate the virtual machine to use 4GB of RAM</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
    <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--memory"</span><span class="p">,</span> <span class="s2">"4048"</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="c1"># Forward the Rails server default port to the host</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">3000</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">3000</span>

  <span class="c1"># Use Chef Solo to provision our virtual machine</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="ss">:chef_solo</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">cookbooks_path</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"cookbooks"</span><span class="p">,</span> <span class="s2">"site-cookbooks"</span><span class="p">]</span>

    <span class="n">chef</span><span class="p">.</span><span class="nf">add_recipe</span> <span class="s2">"apt"</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">add_recipe</span> <span class="s2">"nodejs"</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">add_recipe</span> <span class="s2">"ruby_build"</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">add_recipe</span> <span class="s2">"rbenv::user"</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">add_recipe</span> <span class="s2">"rbenv::vagrant"</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">add_recipe</span> <span class="s2">"vim"</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">add_recipe</span> <span class="s2">"mysql::server"</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">add_recipe</span> <span class="s2">"mysql::client"</span>

    <span class="c1"># Install Ruby 2.3.1 and Bundler</span>
    <span class="c1"># Set an empty root password for MySQL to make things simple</span>
    <span class="n">chef</span><span class="p">.</span><span class="nf">json</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">rbenv: </span><span class="p">{</span>
        <span class="ss">user_installs: </span><span class="p">[{</span>
          <span class="ss">user: </span><span class="s1">'vagrant'</span><span class="p">,</span>
          <span class="ss">rubies: </span><span class="p">[</span><span class="s2">"2.3.1"</span><span class="p">],</span>
          <span class="ss">global: </span><span class="s2">"2.3.1"</span><span class="p">,</span>
          <span class="ss">gems: </span><span class="p">{</span>
            <span class="s2">"2.3.1"</span> <span class="o">=&gt;</span> <span class="p">[</span>
              <span class="p">{</span> <span class="ss">name: </span><span class="s2">"bundler"</span> <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}]</span>
      <span class="p">},</span>
      <span class="ss">mysql: </span><span class="p">{</span>
        <span class="ss">server_root_password: </span><span class="s1">''</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="执行vagrant">执行Vagrant</h2>

<p>至此，我们已经配置好了Vagrant和Chef。我们将启动Vagrant虚拟主机，并通过ssh登陆进去！</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># The commented lines are the output you should see when you run these commands

vagrant up
#==&gt; default: Checking if box 'ubuntu/xenial64' is up to date...
#==&gt; default: Clearing any previously set forwarded ports...
#==&gt; default: Installing Chef cookbooks with Librarian-Chef...
#==&gt; default: The cookbook path '/Users/chris/code/test_app/site-cookbooks' doesn't exist. Ignoring...
#==&gt; default: Clearing any previously set network interfaces...
#==&gt; default: Preparing network interfaces based on configuration...
#    default: Adapter 1: nat
#==&gt; default: Forwarding ports...
#    default: 3000 =&gt; 3000 (adapter 1)
#    default: 22 =&gt; 2222 (adapter 1)
#==&gt; default: Running 'pre-boot' VM customizations...
#==&gt; default: Booting VM...
#==&gt; default: Waiting for machine to boot. This may take a few minutes...
#    default: SSH address: 127.0.0.1:2222
#    default: SSH username: vagrant
#    default: SSH auth method: private key
#    default: Warning: Connection timeout. Retrying...
#==&gt; default: Machine booted and ready!
#==&gt; default: Checking for guest additions in VM...
#==&gt; default: Mounting shared folders...
#    default: /vagrant =&gt; /Users/chris/code/test_app
#   default: /tmp/vagrant-chef-1/chef-solo-1/cookbooks =&gt; /Users/chris/code/test_app/cookbooks
#==&gt; default: VM already provisioned. Run `vagrant provision` or use `--provision` to force it

vagrant ssh
#Welcome to Ubuntu 16.04 LTS (GNU/Linux 3.13.0-24-generic x86_64)
#
# * Documentation:  https://help.ubuntu.com/
#
# System information disabled due to load higher than 1.0
#
#  Get cloud support with Ubuntu Advantage Cloud Guest:
#    http://www.ubuntu.com/business/services/cloud
#
#
#vagrant@vagrant-ubuntu-xenial-64:~$

</code></pre></div></div>

<p>首次启动vagrant需要很长很长很长时间，因为需要准备chef文件中设置的诸多配置项，之后再次执行的话，不再执行Chef就会快很多了。</p>

<p>如果修改了Vagrantfile和Cheffile文件，你需要使用如下命令重新使机器配置生效</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant provision
</code></pre></div></div>

<h2 id="在vagrant中使用rails">在Vagrant中使用Rails</h2>

<p>Vagrant会创建一个名字为/vagrant的共享文件夹，可以是虚拟机和本机之间做文件共享。如果进入/vagrant目录下并执行ls命令，会看到Rails项目的所有文件。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle
</code></pre></div></div>
<p>在虚拟机中安装所有需要的gem。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rbenv rehash
</code></pre></div></div>
<p>确保我们刚刚安装的gem是可用的。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake db:create &amp;&amp; rake db:migrate
</code></pre></div></div>
<p>创建和迁移数据库。</p>

<p>该目录下的Rails服务器通过3000端口对外提供服务。可以通过localhost:3000访问Rails。</p>

<h2 id="结语">结语</h2>

<p>Vagrant是一个非常Diao的工具，非常方便，通过见得的Chef配置文件，我们可以随时随地使用。
如果你需要再次配置一个Vagrant机器，或者是你的合作小伙伴需要配置一个的话，你们只需要执行</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant up
</code></pre></div></div>
<p>即可。</p>

<p>Q&amp;A</p>

<ul>
  <li>
    <p>执行vagrant up命令失败
A：请检查 VirtualBox的版本是否与Vagrant下载扩展的版本一致，我本地使用的是5.0.24 。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>==&gt; default: Machine booted and ready!
[default] GuestAdditions versions on your host (4.3.28) and guest (5.0.24) do not match.
mesg: ttyname failed: Inappropriate ioctl for device
mesg: ttyname failed: Inappropriate ioctl for device
</code></pre></div>    </div>

    <p>另外Vagrant 1.8.4与 VirtualBox5.1.x版本不兼容。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ds git:(dev) ✗ vagrant up --provider=virtualbox
No usable default provider could be found for your system.

Vagrant relies on interactions with 3rd party systems, known as
"providers", to provide Vagrant with resources to run development
environments. Examples are VirtualBox, VMware, Hyper-V.

The easiest solution to this message is to install VirtualBox, which
is available for free on all major platforms.

If you believe you already have a provider available, make sure it
is properly installed and configured. You can see more details about
why a particular provider isn't working by forcing usage with
`vagrant up --provider=PROVIDER`, which should give you a more specific
error message for that particular provider.
➜  ds git:(dev) ✗ cat /etc/profile
</code></pre></div>    </div>
  </li>
  <li>
    <p>需要安装ruby-dev</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install ruby-dev
</code></pre></div>    </div>
  </li>
  <li>
    <p>PostgresSQL 头文件</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install libpq-dev
</code></pre></div>    </div>
  </li>
</ul>

  </div>

</article>

          </div>
        </div>
        
        <div class="pure-u-1-4">
          <div id="sidebar">
            <div class="widget">
              
                <form action="//www.baidu.com/s?gpc=stf" method="get" accept-charset="utf-8" target="_blank" class="search-form">
                  <input type="text" name="q1" maxlength="20" placeholder="Search" class="search-form-input">
                  <input type="hidden" name="q6" value="http://localhost:4000">
                </form>
              
              
            </div>
            
            <div class="widget">
                <div class="widget-title">分类</div>
                <ul class="category-list">
                  
                </ul>
            </div>
              
            <div class="widget">
                <div class="widget-title">标签</div>
                <div class="tagcloud">
                  
                    <a href="/tag/Emacs" style="font-size: 15px;">Emacs</a>
                  
                </div>
            </div>
              
            <div class="widget">
                <div class="widget-title">相关推荐</div>
                <ul class="post-list">
                
                  <li class="post-list-item"><a class="post-list-link" href="/2017/01/21/Emacs-STEP-1.html"> Emacs STEP-1 </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/06/29/Laravel%E5%92%8CDropzone-js%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html"> Laravel和Dropzone.js实现文件上传 </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/06/13/Laravel-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE.html"> Laravel 环境安装和配置 </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/04/08/set-up-oryx-env.html"> 玩转 Oryx2 （一） </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/04/07/Oryx2-performance-doc.html"> Oryx2 性能优化文档 </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/04/06/Oryx2-end-user-doc.html"> Oryx2 终端用户文档 </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/04/06/Oryx2-developer-doc.html"> Oryx2 开发者文档 </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/03/08/Java-keyword-volatile.html"> Java关键字volatile </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/01/24/Reg-Nginx.html"> 正则表达式处理Nginx </a></li>
                
                  <li class="post-list-item"><a class="post-list-link" href="/2016/01/04/Spark-tuning.html"> Spark优化 </a></li>
                
                </ul>
            </div>
              
            <div class="widget">
              <div class="widget-title">友情链接</div>
              
                <a href="/"><i class=""> </i></a>
                <ul></ul><a href="http://people.csail.mit.edu/matei/" title="Matei Zaharia" target="_blank">Matei Zaharia</a>
              
                <a href="/"><i class=""> </i></a>
                <ul></ul><a href="https://github.com/tensorflow/tensorflow" title="tensorflow" target="_blank">tensorflow</a>
              
            </div>
          </div>
        </div>
      </div>
      
      <div id="footer">© 2019 
        <a href="/." rel="nofollow">Tensor Cell.</a> Theme by<a rel="nofollow" target="_blank" href="https://github.com/alafighting/maupassant-jekyll"> Maupassant.</a>
        
      </div>
      

      <a id="rocket" href="#top" class="show"></a>
      
      <script src="/js/jquery.min.js" type="text/javascript"></script>
      <script src="/js/totop.js" type="text/javascript"></script>
      <script src="/js/fancybox.pack.js" type="text/javascript"></script>
      <script src="/js/jquery.fancybox.js" type="text/javascript"></script>
      <link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css">
      
    </div>

    

  </body>

</html>
